<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voila Price Checker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Favicon links -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon_io/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon_io/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon_io/favicon-16x16.png') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon_io/favicon.ico') }}">
    <link rel="manifest" href="{{ url_for('static', filename='favicon_io/site.webmanifest') }}">

    <style>
        :root {
            --voila-cyan: #00d9f9;
            --voila-dark-green: #00483b;
            --voila-orange: #fc6c2b;
            --voila-white: #ffffff;
            --voila-very-dark-green: #002f2c;
            --voila-muted-teal: #2a6762;
            --voila-light-bg: #f8f9fa;
            --voila-gray: #6c757d;
            --voila-red: #dc3545;
            --voila-light-red: #f8d7da;
            --voila-dark-red: #842029;
        }

        body {
            padding-bottom: 40px;
            margin: 0;
            background-color: var(--voila-light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--voila-very-dark-green);
        }

        .container {
            max-width: 1200px;
        }

        /* Navigation Bar Styles */
        .navbar {
            background-color: var(--voila-very-dark-green);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 10px 10px;
        }

        .navbar-brand {
            font-weight: bold;
            color: var(--voila-cyan) !important;
        }

        .logo-text {
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .brand-subtitle {
            color: var(--voila-white);
            font-size: 0.9rem;
            opacity: 0.9;
            letter-spacing: 0.5px;
        }
        
        /* Tab Navigation */
        .nav-tabs {
            margin-bottom: 20px;
            border-bottom: 2px solid var(--voila-dark-green);
        }
        
        .nav-tabs .nav-link {
            color: var(--voila-dark-green);
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            margin-right: 10px;
            border-radius: 0;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: transparent;
            background-color: rgba(0, 72, 59, 0.05);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--voila-dark-green);
            background-color: transparent;
            border-bottom: 3px solid var(--voila-cyan);
            font-weight: 600;
        }

        /* Product Card Styles */
        .product-card {
            margin-bottom: 20px;
            transition: transform 0.2s;
            height: 100%;
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.07);
            border: none;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
        }

        .product-img {
            height: 200px;
            object-fit: contain;
            padding: 10px;
        }

        /* Not Found Card Styles */
        .not-found-card {
            background-color: var(--voila-light-red);
            border-left: 5px solid var(--voila-red);
        }

        .not-found-icon {
            font-size: 4rem;
            color: var(--voila-red);
            opacity: 0.7;
        }

        .not-found-title {
            font-weight: 600;
            color: var(--voila-dark-red);
        }

        .not-found-message {
            color: var(--voila-dark-red);
        }

        /* Session ID Section */
        .session-id-section {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--voila-cyan);
        }

        /* Region Info Banner */
        .region-info-banner {
            background-color: var(--voila-dark-green);
            color: var(--voila-white);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            border-left: 4px solid var(--voila-cyan);
        }

        .region-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            color: var(--voila-cyan);
        }

        /* Instructions */
        .instructions {
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--voila-dark-green);
        }

        /* Price Tag Styles */
        .price-tag {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--voila-dark-green);
        }

        .original-price {
            text-decoration: line-through;
            color: var(--voila-gray);
            font-size: 0.9rem;
        }

        .discount-badge {
            background-color: var(--voila-orange) !important;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-left: 5px;
            font-weight: bold;
        }

        .scene-badge {
            background-color: #6f42c1;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }

        .offer-badge {
            background-color: var(--voila-orange);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }

        /* Search Container */
        .search-container {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 15px;
            display: none;
        }

        .progress {
            height: 24px;
            border-radius: 10px;
            overflow: hidden;
            background-color: #e9ecef;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            background-color: var(--voila-dark-green);
            color: var(--voila-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
            transition: width 0.3s ease;
        }

        .progress-status {
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--voila-dark-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-details {
            font-size: 0.8rem;
            color: var(--voila-gray);
        }
        
        .progress-item-details {
            margin-top: 5px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid var(--voila-cyan);
        }
        
        .progress-item-name {
            font-weight: 600;
            color: var(--voila-dark-green);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .progress-item-info {
            font-size: 0.8rem;
            color: var(--voila-gray);
        }
        
        .progress-metrics {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.85rem;
        }
        
        .progress-metric {
            text-align: center;
            background: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-width: 100px;
        }
        
        .progress-metric-value {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--voila-dark-green);
        }
        
        .progress-metric-label {
            font-size: 0.75rem;
            color: var(--voila-gray);
        }

        /* Duplicate Message */
        .duplicate-message {
            background-color: #e9ecef;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--voila-orange);
        }
        
        .duplicate-list {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9rem;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-top: 8px;
        }

        /* Form Elements Styles */
        .form-control {
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--voila-muted-teal);
            box-shadow: 0 0 0 0.25rem rgba(0, 217, 249, 0.25);
        }

        .form-label {
            font-weight: 500;
            color: var(--voila-dark-green);
            margin-bottom: 0.5rem;
        }
        
        /* Search Type Toggle */
        .search-type-toggle {
            margin-bottom: 20px;
        }
        
        .search-type-toggle .btn-check:checked + .btn {
            background-color: var(--voila-dark-green);
            color: white;
            border-color: var(--voila-dark-green);
        }
        
        .search-type-toggle .btn {
            border-color: var(--voila-dark-green);
            color: var(--voila-dark-green);
            font-weight: 500;
        }
        
        .search-type-toggle .btn:hover {
            background-color: rgba(0, 72, 59, 0.1);
        }
        
        .search-type-toggle .btn i {
            margin-right: 8px;
        }
        
        .search-placeholder {
            font-style: italic;
            color: #adb5bd;
        }

        /* Button Styles */
        .btn-primary {
            background-color: var(--voila-dark-green);
            border-color: var(--voila-dark-green);
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .btn-primary:hover, .btn-primary:focus {
            background-color: var(--voila-muted-teal);
            border-color: var(--voila-muted-teal);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background-color: var(--voila-muted-teal);
            border-color: var(--voila-muted-teal);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .btn-success:hover, .btn-success:focus {
            background-color: #225752;
            border-color: #225752;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Results Section */
        .results-card {
            overflow: visible;
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.07);
            margin-bottom: 20px;
        }

        .results-header {
            background-color: var(--voila-dark-green);
            color: var(--voila-white);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-radius: 12px 12px 0 0;
        }

        .results-header h5 {
            margin-bottom: 0;
            font-weight: 600;
        }

        .parsed-terms {
            background-color: #e9ecef;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--voila-muted-teal);
            max-height: 300px;
            overflow-y: auto;
        }

        .parsed-terms h6 {
            color: var(--voila-dark-green);
            margin-bottom: 10px;
        }

        .parsed-terms ul {
            margin-bottom: 0;
            padding-left: 20px;
        }

        .parsed-terms-toggle {
            cursor: pointer;
            color: var(--voila-muted-teal);
            text-decoration: underline;
        }

        /* Filter Controls */
        .filter-controls {
            background-color: #f1f3f5;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-label {
            font-weight: 600;
            margin-right: 10px;
            color: var(--voila-dark-green);
        }
        
        /* Export Modal */
        .modal-header {
            background-color: var(--voila-dark-green);
            color: white;
        }
        
        .modal-header .btn-close {
            filter: invert(1) brightness(200%);
        }
        
        .export-option {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        
        .export-option:hover {
            background-color: #f8f9fa;
            border-color: var(--voila-cyan);
        }
        
        .export-option input {
            margin-right: 10px;
        }
        
        .export-option label {
            width: 100%;
            cursor: pointer;
            margin-bottom: 0;
        }

        /* Mobile Responsiveness */
        @media (max-width: 767.98px) {
            .card-header {
                padding: 0.85rem 1.25rem;
            }

            .card-body {
                padding: 1.25rem;
            }

            .logo-text {
                font-size: 1.8rem;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .export-btn {
                align-self: flex-start;
            }
            
            .progress-metrics {
                flex-direction: column;
                gap: 8px;
            }
            
            .progress-metric {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <span class="logo-text"><i class="fas fa-shopping-cart me-2"></i>voilà 🍑</span>
                <small class="d-block brand-subtitle">Regional Price Checker</small>
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-tab-pane" type="button" role="tab" aria-controls="search-tab-pane" aria-selected="true">
                    <i class="fas fa-search me-2"></i>Search
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="instructions-tab" data-bs-toggle="tab" data-bs-target="#instructions-tab-pane" type="button" role="tab" aria-controls="instructions-tab-pane" aria-selected="false">
                    <i class="fas fa-info-circle me-2"></i>Instructions
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="myTabContent">
            <!-- Search Tab -->
            <div class="tab-pane fade show active" id="search-tab-pane" role="tabpanel" aria-labelledby="search-tab" tabindex="0">
                <!-- Session ID Input -->
                <div class="search-container">
                    <div class="session-id-section">
                        <div class="mb-3">
                            <label for="sessionId" class="form-label">Voila Session ID:</label>
                            <input type="text" class="form-control" id="sessionId" placeholder="Paste your global_sid here">
                        </div>
                    </div>

                    <!-- Region Info Banner (Initially Hidden) -->
                    <div id="regionInfoBanner" class="region-info-banner" style="display: none;">
                        <i class="fas fa-map-marker-alt region-icon"></i>
                        <div id="regionText"></div>
                    </div>

                    <!-- Duplicate Message (Initially Hidden) -->
                    <div id="duplicateMessage" class="duplicate-message" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="duplicateText"></span>
                        <div id="duplicateList" class="duplicate-list" style="display: none;"></div>
                        <button id="toggleDuplicateList" class="btn btn-sm btn-outline-secondary mt-2" style="display: none;">Show Duplicates</button>
                    </div>
                    
                    <!-- Search Type Toggle -->
                    <div class="search-type-toggle mb-4">
                        <div class="form-label mb-2">Search Type:</div>
                        <div class="btn-group w-100" role="group" aria-label="Search type">
                            <input type="radio" class="btn-check" name="searchType" id="articleSearch" value="article" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="articleSearch">
                                <i class="fas fa-barcode"></i>Article Search
                                <div class="search-placeholder small">Search for specific article codes (e.g. 123456EA)</div>
                            </label>

                            <input type="radio" class="btn-check" name="searchType" id="genericSearch" value="generic" autocomplete="off">
                            <label class="btn btn-outline-primary" for="genericSearch">
                                <i class="fas fa-search"></i>Generic Search
                                <div class="search-placeholder small">Search for general terms (e.g. Water, Coffee)</div>
                            </label>
                        </div>
                    </div>

                    <!-- Search Form -->
                    <div class="mb-3">
                        <label for="searchTerms" class="form-label">
                            <span id="searchTermsLabel">Article Codes:</span>
                        </label>
                        <textarea class="form-control" id="searchTerms" rows="6" placeholder="Paste article codes in any format (comma-separated, one per line, etc.)"></textarea>
                    </div>
                    
                    <!-- Generic Search Options (Initially Hidden) -->
                    <div id="genericSearchOptions" class="mb-3" style="display: none;">
                        <label for="resultLimit" class="form-label">Results per Search Term:</label>
                        <select class="form-select" id="resultLimit">
                            <option value="5">5 results per term</option>
                            <option value="10" selected>10 results per term</option>
                            <option value="20">20 results per term</option>
                            <option value="50">50 results per term (maximum)</option>
                        </select>
                    </div>
                    
                    <button id="searchButton" class="btn btn-primary w-100 mb-3">Search Products</button>
                    <button id="exportButton" class="btn btn-success w-100" style="display: none;">Export to Excel</button>
                </div>

                <!-- Loading Spinner -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2" id="loadingMessage">Searching products...</p>
                    
                    <!-- Enhanced Progress Bar -->
                    <div class="progress-container" id="progressContainer">
                        <div class="progress">
                            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div class="progress-status" id="progressStatus">
                            <span id="progressStatusText">Initializing search...</span>
                            <span id="progressTimeRemaining"></span>
                        </div>
                        
                        <div class="progress-metrics mt-3">
                            <div class="progress-metric">
                                <div class="progress-metric-value" id="progressProcessed">0</div>
                                <div class="progress-metric-label">Processed</div>
                            </div>
                            <div class="progress-metric">
                                <div class="progress-metric-value" id="progressTotal">0</div>
                                <div class="progress-metric-label">Total Items</div>
                            </div>
                            <div class="progress-metric">
                                <div class="progress-metric-value" id="progressFound">0</div>
                                <div class="progress-metric-label">Found</div>
                            </div>
                            <div class="progress-metric">
                                <div class="progress-metric-value" id="progressNotFound">0</div>
                                <div class="progress-metric-label">Not Found</div>
                            </div>
                        </div>
                        
                        <div class="progress-item-details" id="currentItemDetails" style="display: none;">
                            <div class="progress-item-name" id="currentItemName">Processing: </div>
                            <div class="progress-item-info" id="currentItemInfo"></div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="searchInfo" class="results-card" style="display: none;">
                    <div class="results-header">
                        <h5 id="searchResultsTitle">Search Results</h5>
                        <span id="resultStats" class="badge bg-light text-dark"></span>
                    </div>
                    <div class="card-body">
                        <!-- Parsed Terms Section (Initially Hidden) -->
                        <div id="parsedTermsSection" class="parsed-terms" style="display: none;">
                            <div class="d-flex justify-content-between">
                                <h6>Parsed Search Terms</h6>
                                <span id="hideTermsToggle" class="parsed-terms-toggle">Hide</span>
                            </div>
                            <div id="parsedTermsList"></div>
                        </div>
                        
                        <!-- Filter Controls -->
                        <div id="filterControls" class="filter-controls" style="display: none;">
                            <div class="row">
                                <div class="col-md-12 mb-2">
                                    <span class="filter-label">Show:</span>
                                    <div class="btn-group" role="group">
                                        <input type="radio" class="btn-check" name="productFilter" id="filterAll" autocomplete="off" checked>
                                        <label class="btn btn-outline-secondary" for="filterAll">All Products</label>
                                        
                                        <input type="radio" class="btn-check" name="productFilter" id="filterFound" autocomplete="off">
                                        <label class="btn btn-outline-success" for="filterFound">Found Products</label>
                                        
                                        <input type="radio" class="btn-check" name="productFilter" id="filterNotFound" autocomplete="off">
                                        <label class="btn btn-outline-danger" for="filterNotFound">Not Found</label>
                                        
                                        <input type="radio" class="btn-check" name="productFilter" id="filterAvailable" autocomplete="off">
                                        <label class="btn btn-outline-primary" for="filterAvailable">Available</label>
                                        
                                        <input type="radio" class="btn-check" name="productFilter" id="filterUnavailable" autocomplete="off">
                                        <label class="btn btn-outline-warning" for="filterUnavailable">Unavailable</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="resultsContainer" class="row"></div>
                    </div>
                </div>
            </div>
            
            <!-- Instructions Tab -->
            <div class="tab-pane fade" id="instructions-tab-pane" role="tabpanel" aria-labelledby="instructions-tab" tabindex="0">
                <div class="instructions">
                    <h4>How to Use the Voila Price Checker</h4>
                    <p>This tool allows you to search for products on Voila.ca using your personal session ID in two different ways:</p>
                    
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-barcode me-2"></i>Article Search</h5>
                        </div>
                        <div class="card-body">
                            <p>Use this mode when you have specific article codes or product IDs to look up.</p>
                            <ol>
                                <li>Enter your Voila session ID</li>
                                <li>Select "Article Search" mode</li>
                                <li>Paste a list of article codes in any format (comma-separated, one per line, etc.)</li>
                                <li>Click "Search Products"</li>
                            </ol>
                            <div class="alert alert-info">
                                <strong>Article Code Formats:</strong> The tool automatically detects and parses article codes in various formats:
                                <ul>
                                    <li>Comma-separated: <code>123456EA, 789012EA</code></li>
                                    <li>One code per line (as copied from Excel)</li>
                                    <li>Space-separated: <code>123456EA 789012EA</code></li>
                                    <li>Continuous list: <code>123456EA789012EA</code> will be automatically parsed</li>
                                </ul>
                                Duplicate codes will be automatically detected and removed.
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-search me-2"></i>Generic Search</h5>
                        </div>
                        <div class="card-body">
                            <p>Use this mode when you want to search for general terms like "Water" or "Coffee".</p>
                            <ol>
                                <li>Enter your Voila session ID</li>
                                <li>Select "Generic Search" mode</li>
                                <li>Enter a search term</li>
                                <li>Choose how many results you want per term (up to 50)</li>
                                <li>Click "Search Products"</li>
                            </ol>
                            <div class="alert alert-warning">
                                Generic searches will return multiple matching products per term, up to the limit you specify.
                            </div>
                        </div>
                    </div>

                    <h5 class="mt-3">How to Get Your Session ID:</h5>
                    <ol>
                        <li>Log in to your Voila.ca account</li>
                        <li>Book a time in the region you want to search</li>
                        <li>Open your browser's developer tools (F12 or right-click and select "Inspect")</li>
                        <li>Go to the "Application" or "Storage" tab</li>
                        <li>Look for "Cookies" and find the "global_sid" cookie value</li>
                        <li>Copy the entire value and paste it in the Session ID field</li>
                    </ol>
                    
                    <h5 class="mt-3">Features:</h5>
                    <ul>
                        <li><strong>Progress Tracking</strong> - For large batches, you'll see detailed progress information</li>
                        <li><strong>Filtering</strong> - Use the filter controls to show only specific types of products</li>
                        <li><strong>Export to Excel</strong> - Export your search results with various filtering options</li>
                        <li><strong>Duplicate Detection</strong> - Automatic detection and removal of duplicate search terms</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportModalLabel">Export Options</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select what to include in the export:</p>
                    
                    <div class="export-option">
                        <input type="radio" name="exportOption" id="exportAll" checked>
                        <label for="exportAll">All Products</label>
                    </div>
                    
                    <div class="export-option">
                        <input type="radio" name="exportOption" id="exportFound">
                        <label for="exportFound">Found Products Only</label>
                    </div>
                    
                    <div class="export-option">
                        <input type="radio" name="exportOption" id="exportNotFound">
                        <label for="exportNotFound">Not Found Products Only</label>
                    </div>
                    
                    <div class="export-option">
                        <input type="radio" name="exportOption" id="exportAvailable">
                        <label for="exportAvailable">Available Products Only</label>
                    </div>
                    
                    <div class="export-option">
                        <input type="radio" name="exportOption" id="exportUnavailable">
                        <label for="exportUnavailable">Unavailable Products Only</label>
                    </div>
                    
                    <div class="export-option">
                        <input type="radio" name="exportOption" id="exportCurrentView">
                        <label for="exportCurrentView">Current View (As Filtered)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmExport">Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Variables
            const searchButton = document.getElementById('searchButton');
            const exportButton = document.getElementById('exportButton');
            const confirmExportButton = document.getElementById('confirmExport');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const loadingMessage = document.getElementById('loadingMessage');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressStatusText = document.getElementById('progressStatusText');
            const progressTimeRemaining = document.getElementById('progressTimeRemaining');
            const progressProcessed = document.getElementById('progressProcessed');
            const progressTotal = document.getElementById('progressTotal');
            const progressFound = document.getElementById('progressFound');
            const progressNotFound = document.getElementById('progressNotFound');
            const currentItemDetails = document.getElementById('currentItemDetails');
            const currentItemName = document.getElementById('currentItemName');
            const currentItemInfo = document.getElementById('currentItemInfo');
            const resultsContainer = document.getElementById('resultsContainer');
            const searchInfo = document.getElementById('searchInfo');
            const resultStats = document.getElementById('resultStats');
            const searchResultsTitle = document.getElementById('searchResultsTitle');
            const regionInfoBanner = document.getElementById('regionInfoBanner');
            const regionText = document.getElementById('regionText');
            const parsedTermsSection = document.getElementById('parsedTermsSection');
            const parsedTermsList = document.getElementById('parsedTermsList');
            const hideTermsToggle = document.getElementById('hideTermsToggle');
            const filterControls = document.getElementById('filterControls');
            const duplicateMessage = document.getElementById('duplicateMessage');
            const duplicateText = document.getElementById('duplicateText');
            const duplicateList = document.getElementById('duplicateList');
            const toggleDuplicateList = document.getElementById('toggleDuplicateList');
            const searchTermsLabel = document.getElementById('searchTermsLabel');
            const searchTerms = document.getElementById('searchTerms');
            const genericSearchOptions = document.getElementById('genericSearchOptions');
            
            // Search type radio buttons
            const articleSearch = document.getElementById('articleSearch');
            const genericSearch = document.getElementById('genericSearch');
            
            // Filter options
            const filterAll = document.getElementById('filterAll');
            const filterFound = document.getElementById('filterFound');
            const filterNotFound = document.getElementById('filterNotFound');
            const filterAvailable = document.getElementById('filterAvailable');
            const filterUnavailable = document.getElementById('filterUnavailable');

            // Export modal
            const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));

            // Store results for export
            let allSearchResults = [];
            let totalFoundProducts = 0;
            let displayedProducts = 0;
            let notFoundProducts = 0;
            let currentRegionInfo = null;
            let parsedTerms = [];
            let duplicatesFound = [];
            let isProcessingLargeRequest = false;
            let streamingResponse = null;
            let abortController = null;
            let searchStartTime = null;
            
            // Progress tracking for estimated time
            let progressUpdateTimes = [];
            let progressUpdateValues = [];

            // Set up event listeners
            searchButton.addEventListener('click', searchProducts);
            exportButton.addEventListener('click', function() {
                // Show export modal instead of directly exporting
                exportModal.show();
            });
            
            confirmExportButton.addEventListener('click', function() {
                // Hide the modal
                exportModal.hide();
                
                // Determine which export option was selected
                let option = 'all';
                if (document.getElementById('exportFound').checked) option = 'found';
                else if (document.getElementById('exportNotFound').checked) option = 'notFound';
                else if (document.getElementById('exportAvailable').checked) option = 'available';
                else if (document.getElementById('exportUnavailable').checked) option = 'unavailable';
                else if (document.getElementById('exportCurrentView').checked) option = 'currentView';
                
                // Export with the selected option
                exportToExcel(option);
            });
            
            // Toggle for parsed terms section
            hideTermsToggle.addEventListener('click', function() {
                const termsListDiv = parsedTermsList;
                if (termsListDiv.style.display === 'none') {
                    termsListDiv.style.display = 'block';
                    this.textContent = 'Hide';
                } else {
                    termsListDiv.style.display = 'none';
                    this.textContent = 'Show';
                }
            });
            
            // Toggle for duplicate list
            toggleDuplicateList.addEventListener('click', function() {
                if (duplicateList.style.display === 'none') {
                    duplicateList.style.display = 'block';
                    this.textContent = 'Hide Duplicates';
                } else {
                    duplicateList.style.display = 'none';
                    this.textContent = 'Show Duplicates';
                }
            });
            
            // Search type listeners
            articleSearch.addEventListener('change', updateSearchType);
            genericSearch.addEventListener('change', updateSearchType);
            
            function updateSearchType() {
                if (articleSearch.checked) {
                    // Article search mode
                    searchTermsLabel.textContent = 'Article Codes:';
                    searchTerms.placeholder = 'Paste article codes in any format (comma-separated, one per line, etc.)';
                    genericSearchOptions.style.display = 'none';
                } else {
                    // Generic search mode
                    searchTermsLabel.textContent = 'Search Terms:';
                    searchTerms.placeholder = 'Enter general search terms like "Water" or "Coffee"';
                    genericSearchOptions.style.display = 'block';
                }
            }
            
            // Filter event listeners
            [filterAll, filterFound, filterNotFound, filterAvailable, filterUnavailable].forEach(
                filter => filter.addEventListener('change', filterResults)
            );

            // Add event listener to check region info when session ID changes
            document.getElementById('sessionId').addEventListener('blur', checkRegionInfo);

            // Also check session ID when pasted
            document.getElementById('sessionId').addEventListener('paste', function() {
                // Short delay to allow paste to complete
                setTimeout(checkRegionInfo, 100);
            });

            // Search when Enter key is pressed in search input while Ctrl is held
            document.getElementById('searchTerms').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    searchProducts();
                }
            });

            // Function to filter results based on radio buttons
            function filterResults() {
                let showCondition;
                
                if (filterAll.checked) {
                    // Show all products
                    showCondition = () => true;
                } else if (filterFound.checked) {
                    // Show only found products
                    showCondition = product => product.classList.contains('found-product');
                } else if (filterNotFound.checked) {
                    // Show only not found products
                    showCondition = product => product.classList.contains('not-found-card');
                } else if (filterAvailable.checked) {
                    // Show only available products
                    showCondition = product => product.classList.contains('found-product') && 
                                              product.querySelector('.badge-available');
                } else if (filterUnavailable.checked) {
                    // Show only unavailable products
                    showCondition = product => product.classList.contains('found-product') && 
                                              product.querySelector('.badge-unavailable');
                }
                
                // Apply filter to all product cards
                const allProductCards = document.querySelectorAll('.product-card');
                let visibleCount = 0;
                
                allProductCards.forEach(card => {
                    const parentCol = card.closest('.col-md-4');
                    if (parentCol) {
                        if (showCondition(card)) {
                            parentCol.style.display = 'block';
                            visibleCount++;
                        } else {
                            parentCol.style.display = 'none';
                        }
                    }
                });
                
                // Update results stats
                resultStats.textContent = `Found ${totalFoundProducts} products, ${notFoundProducts} not found, showing ${visibleCount} of ${displayedProducts} total`;
            }

            // Function to check region info when session ID is entered
            function checkRegionInfo() {
                const sessionId = document.getElementById('sessionId').value.trim();

                if (!sessionId) {
                    regionInfoBanner.style.display = 'none';
                    return;
                }

                // Show loading message
                regionInfoBanner.style.display = 'flex';
                regionText.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> Checking region information...';

                // Make API request to get region info
                fetch('/api/fetch-product', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        searchTerm: 'milk',  // Use a common term just to get region info
                        limit: 1,  // Only need one result
                        searchType: 'article' // Use article search type
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    
                    // Check if there's content
                    if (response.headers.get('content-length') === '0') {
                        throw new Error('Server returned an empty response');
                    }
                    
                    // Parse as JSON with error handling
                    return response.text().then(text => {
                        if (!text || text.trim() === '') {
                            throw new Error('Empty response from server');
                        }
                        
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            console.error('JSON parse error:', e);
                            console.error('Raw response:', text);
                            throw new Error(`Invalid JSON response: ${e.message}`);
                        }
                    });
                })
                .then(data => {
                    if (data.error) {
                        regionInfoBanner.style.display = 'none';
                        alert(`Error: ${data.error}`);
                        return;
                    }

                    // Extract region info
                    if (data.region_info) {
                        currentRegionInfo = data.region_info;

                        // Update region banner
                        regionInfoBanner.style.display = 'flex';
                        const regionName = data.region_info.nickname || 'Unknown Region';
                        const address = data.region_info.displayAddress || '';
                        const postalCode = data.region_info.postalCode || '';

                        regionText.innerHTML = `
                            <div>
                                <strong>Request sent from ${regionName} region</strong><br>
                                ${address}<br>
                                Postal Code: ${postalCode}
                            </div>
                        `;
                    } else {
                        regionInfoBanner.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching region info:', error);
                    regionInfoBanner.style.display = 'none';
                    alert('Error fetching region information. Please check your session ID.');
                });
            }

            // Function to handle streaming response for large requests
            function handleStreamingResponse(reader, decoder, buffer = "") {
                return reader.read().then(({ done, value }) => {
                    if (done) {
                        console.log("Stream complete");
                        if (buffer.length > 0) {
                            try {
                                const jsonData = JSON.parse(buffer);
                                processResults(jsonData);
                            } catch (e) {
                                console.error("Error parsing final buffer:", e);
                                console.error("Buffer content:", buffer);
                            }
                        }
                        
                        // Hide loading spinner when done
                        loadingSpinner.style.display = 'none';
                        
                        // Update progress bar
                        updateProgress(100, "Processing complete!", null, true);
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                        }, 2000);
                        
                        isProcessingLargeRequest = false;
                        streamingResponse = null;
                        return;
                    }
                    
                    // Decode the current chunk
                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    
                    try {
                        // Try to parse the buffer as JSON
                        const jsonData = JSON.parse(buffer);
                        // If we get here, it's valid JSON
                        processResults(jsonData);
                        buffer = "";
                    } catch (e) {
                        // Not valid JSON yet, continue accumulating
                        // Nothing to do, just continue
                    }
                    
                    // Continue reading
                    return handleStreamingResponse(reader, decoder, buffer);
                });
            }

            // Function to calculate estimated time remaining
            function calculateTimeRemaining(percentComplete) {
                const now = Date.now();
                
                // Add the current progress to our tracking arrays
                progressUpdateTimes.push(now);
                progressUpdateValues.push(percentComplete);
                
                // Keep only the last 10 updates for calculation
                if (progressUpdateTimes.length > 10) {
                    progressUpdateTimes.shift();
                    progressUpdateValues.shift();
                }
                
                // Need at least 2 points to estimate
                if (progressUpdateTimes.length < 2) {
                    return "Calculating...";
                }
                
                // Calculate rate of progress
                const oldestTime = progressUpdateTimes[0];
                const oldestValue = progressUpdateValues[0];
                const timeElapsed = now - oldestTime; // ms
                const progressMade = percentComplete - oldestValue; // percentage points
                
                // Avoid division by zero
                if (progressMade <= 0) {
                    return "Calculating...";
                }
                
                // Calculate rate: percentage points per ms
                const rate = progressMade / timeElapsed;
                
                // Calculate remaining time
                const remainingProgress = 100 - percentComplete;
                const estimatedTimeRemaining = remainingProgress / rate; // ms
                
                // Format nicely
                if (estimatedTimeRemaining < 60000) {
                    // Less than a minute
                    return `~${Math.round(estimatedTimeRemaining / 1000)}s remaining`;
                } else {
                    // Minutes and seconds
                    const minutes = Math.floor(estimatedTimeRemaining / 60000);
                    const seconds = Math.round((estimatedTimeRemaining % 60000) / 1000);
                    return `~${minutes}m ${seconds}s remaining`;
                }
            }

            // Function to update progress bar
            function updateProgress(percent, statusText, currentItem = null, finished = false) {
                if (progressContainer.style.display === 'none') {
                    progressContainer.style.display = 'block';
                }
                
                // Update progress bar
                progressBar.style.width = `${percent}%`;
                progressBar.setAttribute('aria-valuenow', percent);
                progressBar.textContent = `${Math.round(percent)}%`;
                progressStatusText.textContent = statusText;
                
                // Update time remaining if not finished
                if (!finished) {
                    progressTimeRemaining.textContent = calculateTimeRemaining(percent);
                } else {
                    progressTimeRemaining.textContent = "Complete!";
                }
                
                // Update current item if provided
                if (currentItem) {
                    currentItemDetails.style.display = 'block';
                    currentItemName.textContent = `Processing: ${currentItem.searchTerm || currentItem}`;
                    
                    // If this is a product with more details, show them
                    if (currentItem.name) {
                        currentItemInfo.style.display = 'block';
                        currentItemInfo.textContent = currentItem.found ? 
                            `Found: ${currentItem.name} (${currentItem.available ? 'Available' : 'Unavailable'})` : 
                            `Not found: ${currentItem.notFoundMessage || 'No details available'}`;
                    } else {
                        currentItemInfo.style.display = 'none';
                    }
                }
            }

            // Function to process and display search results
            function processResults(data) {
                // If this is not a streaming response, hide loading spinner
                if (!isProcessingLargeRequest) {
                    loadingSpinner.style.display = 'none';
                }
                
                // If there's an error, show it and stop
                if (data.error) {
                    searchInfo.style.display = 'block';
                    searchResultsTitle.textContent = `Error`;
                    resultStats.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    return;
                }

                // Store region info if available
                if (data.region_info) {
                    currentRegionInfo = data.region_info;

                    // Update region banner
                    regionInfoBanner.style.display = 'flex';
                    const regionName = data.region_info.nickname || 'Unknown Region';
                    const address = data.region_info.displayAddress || '';
                    const postalCode = data.region_info.postalCode || '';

                    regionText.innerHTML = `
                        <div>
                            <strong>Request sent from ${regionName} region</strong><br>
                            ${address}<br>
                            Postal Code: ${postalCode}
                        </div>
                    `;
                }

                // Display duplicate message if there are duplicates in article search mode
                if (data.duplicate_count > 0 && data.search_type === 'article') {
                    duplicatesFound = data.duplicates || [];
                    
                    duplicateMessage.style.display = 'block';
                    duplicateText.textContent = `Found and removed ${data.duplicate_count} duplicate article code${data.duplicate_count > 1 ? 's' : ''}.`;
                    
                    // Show the toggle button if we have duplicates
                    if (duplicatesFound.length > 0) {
                        toggleDuplicateList.style.display = 'inline-block';
                        
                        // Populate the duplicate list
                        duplicateList.innerHTML = '';
                        const dupList = document.createElement('ul');
                        duplicatesFound.forEach(dup => {
                            const item = document.createElement('li');
                            item.textContent = dup;
                            dupList.appendChild(item);
                        });
                        duplicateList.appendChild(dupList);
                    } else {
                        toggleDuplicateList.style.display = 'none';
                    }
                } else {
                    duplicateMessage.style.display = 'none';
                    toggleDuplicateList.style.display = 'none';
                }

                // Display parsed terms if available
                if (data.parsed_terms && data.parsed_terms.length > 0) {
                    parsedTerms = data.parsed_terms;
                    
                    // Show the parsed terms section
                    parsedTermsSection.style.display = 'block';
                    parsedTermsList.innerHTML = '';
                    
                    // Create the list of parsed terms
                    const termsList = document.createElement('ul');
                    parsedTerms.forEach(term => {
                        const listItem = document.createElement('li');
                        listItem.textContent = term;
                        termsList.appendChild(listItem);
                    });
                    
                    parsedTermsList.appendChild(termsList);
                }

                // For streaming responses, update progress if available
                if (data.status === 'processing' && data.total_terms && data.total_batches) {
                    loadingMessage.textContent = `Processing ${data.total_terms} ${data.search_type === 'article' ? 'article codes' : 'search terms'} in ${data.total_batches} batches...`;
                    progressTotal.textContent = data.total_terms;
                }

                // Count found and not found products
                if (data.products && data.products.length) {
                    // Store all products for display and export
                    allSearchResults = data.products;
                    
                    // Count normal and not found products
                    const foundProducts = data.products.filter(p => p.found === true);
                    const notFoundProds = data.products.filter(p => p.found === false);
                    
                    totalFoundProducts = data.total_found || foundProducts.length;
                    notFoundProducts = notFoundProds.length;
                    displayedProducts = data.products.length;
                    
                    // Show filter controls if we have products
                    if (data.products.length > 0) {
                        filterControls.style.display = 'block';
                    }
                    
                    // For streaming response, update progress based on processed products
                    if (isProcessingLargeRequest && data.total_processed && data.total_terms) {
                        const percentComplete = (data.total_processed / data.total_terms) * 100;
                        const latestProduct = data.products.length > 0 ? data.products[data.products.length - 1] : null;
                        
                        // Update progress metrics
                        progressProcessed.textContent = data.total_processed;
                        progressFound.textContent = totalFoundProducts;
                        progressNotFound.textContent = notFoundProducts;
                        
                        updateProgress(
                            percentComplete,
                            `Processed ${data.total_processed} of ${data.total_terms} terms`,
                            latestProduct
                        );
                    }
                }

                // Update results title
                const regionName = currentRegionInfo?.nickname || 'Unknown Region';
                searchResultsTitle.textContent = `Search Results for ${regionName}`;

                // Update stats
                resultStats.textContent = `Found ${totalFoundProducts} products, ${notFoundProducts} not found, showing ${displayedProducts} total`;

                // Show export button if we have results
                exportButton.style.display = allSearchResults.length > 0 ? 'block' : 'none';

                // Show results section
                searchInfo.style.display = 'block';

                // Display products
                displayResults(allSearchResults, resultsContainer);
                
                // Apply default filter (show all)
                filterAll.checked = true;
                filterResults();
            }

            // Abort any in-progress request
            function abortCurrentRequest() {
                if (abortController) {
                    abortController.abort();
                    abortController = null;
                }
                
                if (streamingResponse) {
                    try {
                        // Try to cancel the reader if it exists
                        if (streamingResponse.reader && streamingResponse.reader.cancel) {
                            streamingResponse.reader.cancel();
                        }
                    } catch (e) {
                        console.error("Error cancelling stream:", e);
                    }
                    streamingResponse = null;
                }
                
                isProcessingLargeRequest = false;
            }

            // Main search function
            function searchProducts() {
                // Reset any previous search
                abortCurrentRequest();
                
                const sessionId = document.getElementById('sessionId').value.trim();
                const searchTermsInput = document.getElementById('searchTerms').value.trim();
                const resultLimit = document.getElementById('resultLimit').value;
                const searchType = articleSearch.checked ? 'article' : 'generic';

                // Validate inputs
                if (!sessionId) {
                    alert('Please enter your Voila session ID');
                    return;
                }

                if (!searchTermsInput) {
                    alert('Please enter at least one search term');
                    return;
                }
                
                // Create abort controller for request cancellation
                abortController = new AbortController();

                // Show loading spinner
                loadingSpinner.style.display = 'block';
                progressContainer.style.display = 'none';
                currentItemDetails.style.display = 'none';
                loadingMessage.textContent = searchType === 'article' ? 'Searching for articles...' : 'Performing generic search...';
                resultsContainer.innerHTML = '';
                searchInfo.style.display = 'none';
                exportButton.style.display = 'none';
                parsedTermsSection.style.display = 'none';
                filterControls.style.display = 'none';
                duplicateMessage.style.display = 'none';
                duplicateList.style.display = 'none';
                toggleDuplicateList.style.display = 'none';

                // Reset progress tracking
                searchStartTime = Date.now();
                progressUpdateTimes = [];
                progressUpdateValues = [];
                progressProcessed.textContent = '0';
                progressTotal.textContent = '0';
                progressFound.textContent = '0';
                progressNotFound.textContent = '0';

                // Reset results
                allSearchResults = [];
                totalFoundProducts = 0;
                displayedProducts = 0;
                notFoundProducts = 0;
                parsedTerms = [];
                duplicatesFound = [];

                // Prepare request payload
                const payload = {
                    sessionId: sessionId,
                    searchTerm: searchTermsInput,
                    limit: resultLimit,
                    searchType: searchType
                };
                
                // Check if this might be a large request based on search type and input size
                let isLargeRequest = false;
                
                if (searchType === 'article') {
                    // For article search, check commas, lines, EA codes
                    const commaCount = (searchTermsInput.match(/,/g) || []).length;
                    const lineCount = (searchTermsInput.match(/\n/g) || []).length;
                    const eaCodeCount = (searchTermsInput.match(/\d+EA/g) || []).length;
                    
                    isLargeRequest = (commaCount + lineCount > 50) || (eaCodeCount > 50) || searchTermsInput.length > 1000;
                } else {
                    // For generic search, not likely to be a large batch request
                    isLargeRequest = false;
                }
                
                isProcessingLargeRequest = isLargeRequest;
                
                if (isProcessingLargeRequest) {
                    // For large requests, use streaming response
                    loadingMessage.textContent = 'Processing large request, please wait...';
                    updateProgress(0, 'Preparing to process large batch of product codes...');
                    
                    fetch('/api/fetch-product', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload),
                        signal: abortController.signal
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }
                        
                        // Initialize stream processing
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        // Store stream info for potential cancellation
                        streamingResponse = { reader, decoder };
                        
                        // Begin processing the stream
                        return handleStreamingResponse(reader, decoder);
                    })
                    .catch(error => {
                        loadingSpinner.style.display = 'none';
                        searchInfo.style.display = 'block';
                        searchResultsTitle.textContent = `Error`;
                        
                        let errorMessage;
                        if (error.name === 'AbortError') {
                            errorMessage = '<div class="alert alert-warning">Search was cancelled.</div>';
                        } else {
                            console.error('Request error:', error);
                            errorMessage = `<div class="alert alert-danger">
                                <strong>Error:</strong> ${error.message}
                                <hr>
                                <p>Troubleshooting tips:</p>
                                <ul>
                                    <li>Check your internet connection</li>
                                    <li>Verify your session ID is still valid</li>
                                    <li>Your search might be too large - try reducing the number of terms</li>
                                    <li>Try refreshing the page and searching again</li>
                                </ul>
                            </div>`;
                        }
                        
                        resultStats.innerHTML = errorMessage;
                        
                        isProcessingLargeRequest = false;
                        streamingResponse = null;
                    });
                    
                } else {
                    // For regular requests, use normal fetch
                    fetch('/api/fetch-product', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload),
                        signal: abortController.signal
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }
                        
                        // Check if there's content
                        if (response.headers.get('content-length') === '0') {
                            throw new Error('Server returned an empty response');
                        }
                        
                        // Parse as JSON with error handling
                        return response.text().then(text => {
                            if (!text || text.trim() === '') {
                                throw new Error('Empty response from server');
                            }
                            
                            try {
                                return JSON.parse(text);
                            } catch (e) {
                                console.error('JSON parse error:', e);
                                console.error('Raw response:', text);
                                throw new Error(`Invalid JSON response: ${e.message}`);
                            }
                        });
                    })
                    .then(data => {
                        processResults(data);
                    })
                    .catch(error => {
                        loadingSpinner.style.display = 'none';
                        searchInfo.style.display = 'block';
                        searchResultsTitle.textContent = `Error`;
                        
                        let errorMessage;
                        if (error.name === 'AbortError') {
                            errorMessage = '<div class="alert alert-warning">Search was cancelled.</div>';
                        } else {
                            console.error('Request error:', error);
                            errorMessage = `<div class="alert alert-danger">
                                <strong>Error:</strong> ${error.message}
                                <hr>
                                <p>Troubleshooting tips:</p>
                                <ul>
                                    <li>Check your internet connection</li>
                                    <li>Verify your session ID is still valid</li>
                                    <li>Your search might be too large - try reducing the number of terms</li>
                                    <li>Try refreshing the page and searching again</li>
                                </ul>
                            </div>`;
                        }
                        
                        resultStats.innerHTML = errorMessage;
                    });
                }
            }

            function displayResults(products, containerElement) {
                if (!products || products.length === 0) {
                    containerElement.innerHTML = '<div class="col-12 text-center"><p>No products found. Try different search terms.</p></div>';
                    return;
                }

                // Only clear previous results if not streaming
                if (!isProcessingLargeRequest) {
                    containerElement.innerHTML = '';
                }

                // Separate found and not found products
                const foundProducts = products.filter(product => product.found === true);
                const notFoundProducts = products.filter(product => product.found === false);

                // Display found products first
                foundProducts.forEach(product => {
                    // Only add if this product isn't already displayed
                    if (!document.getElementById(`product-${product.retailerProductId || product.productId || product.searchTerm}`)) {
                        const productCard = createProductCard(product);
                        containerElement.appendChild(productCard);
                    }
                });

                // Then display not found products
                notFoundProducts.forEach(product => {
                    // Only add if this product isn't already displayed
                    if (!document.getElementById(`not-found-${product.searchTerm}`)) {
                        const notFoundCard = createNotFoundCard(product);
                        containerElement.appendChild(notFoundCard);
                    }
                });
            }

            function createProductCard(product) {
                const productCard = document.createElement('div');
                productCard.className = 'col-md-4 col-lg-3 mb-4';
                productCard.id = `product-${product.retailerProductId || product.productId || product.searchTerm}`;

                // Format price display - Handle non-number values
                let priceDisplay = '';
                let discountBadge = '';

                if (product.currentPrice !== null && product.currentPrice !== undefined) {
                    // Safely format the current price
                    const formattedPrice = typeof product.currentPrice === 'number' 
                        ? product.currentPrice.toFixed(2) 
                        : product.currentPrice;

                    priceDisplay = `<div class="price-tag">$${formattedPrice}`;

                    // Handle discount percentage if available
                    if (product.discountPercentage) {
                        discountBadge = `<span class="discount-badge">-${product.discountPercentage}%</span>`;
                        priceDisplay += discountBadge;
                    }

                    priceDisplay += `</div>`;

                    // Handle original price if it exists
                    if (product.originalPrice && product.originalPrice > product.currentPrice) {
                        // Safely format the original price
                        const formattedOriginal = typeof product.originalPrice === 'number'
                            ? product.originalPrice.toFixed(2)
                            : product.originalPrice;

                        priceDisplay += `<div class="original-price">$${formattedOriginal}</div>`;
                    }
                } else {
                    priceDisplay = '<div class="price-tag">Price unavailable</div>';
                }

                // Format unit price if available
                let unitPriceDisplay = '';
                if (product.unitPrice && product.unitLabel) {
                    // Safely format the unit price
                    const formattedUnitPrice = typeof product.unitPrice === 'number'
                        ? product.unitPrice.toFixed(2)
                        : product.unitPrice;

                    unitPriceDisplay = `<div class="small text-muted">$${formattedUnitPrice} / ${product.unitLabel}</div>`;
                }

                // Format availability badge with classes for filtering
                const availabilityClass = product.available ? 'badge-available' : 'badge-unavailable';
                const availabilityBadge = product.available
                    ? `<span class="badge bg-success ${availabilityClass}">Available</span>`
                    : `<span class="badge bg-danger ${availabilityClass}">Unavailable</span>`;

                // Format offers and Scene+ offers
                let offersDisplay = '';
                if (product.offers && product.offers.length > 0) {
                    offersDisplay = '<div class="mt-2 mb-2">';

                    product.offers.forEach(offer => {
                        if (offer.description && offer.description.includes('SCENE+')) {
                            offersDisplay += `<span class="scene-badge">${offer.description}</span>`;
                        } else if (offer.description) {
                            offersDisplay += `<span class="offer-badge">${offer.description}</span>`;
                        }
                    });

                    offersDisplay += '</div>';
                }

                // Add search term badge if available
                const searchTermBadge = product.searchTerm 
                    ? `<div class="mb-2"><span class="badge bg-info">${product.searchTerm}</span></div>` 
                    : '';

                productCard.innerHTML = `
                    <div class="card product-card found-product">
                        <img src="${product.imageUrl || 'https://via.placeholder.com/200x200?text=No+Image'}" 
                             class="card-img-top product-img" alt="${product.name || 'Product Image'}">
                        <div class="card-body">
                            <h5 class="card-title">${product.name || 'Unknown Product'}</h5>
                            <p class="card-text small text-muted">${product.brand || 'Unknown brand'}</p>
                            ${searchTermBadge}
                            ${offersDisplay}
                            <div class="mb-2">
                                ${priceDisplay}
                                ${unitPriceDisplay}
                            </div>
                            <div>
                                ${availabilityBadge}
                            </div>
                        </div>
                        <div class="card-footer bg-white">
                            <small class="text-muted">ID: ${product.retailerProductId || product.productId || 'N/A'}</small>
                        </div>
                    </div>
                `;

                return productCard;
            }

            function createNotFoundCard(product) {
                const notFoundCard = document.createElement('div');
                notFoundCard.className = 'col-md-4 col-lg-3 mb-4';
                notFoundCard.id = `not-found-${product.searchTerm}`;

                // Add search term badge if available
                const searchTermBadge = product.searchTerm 
                    ? `<div class="mb-2"><span class="badge bg-info">${product.searchTerm}</span></div>` 
                    : '';

                notFoundCard.innerHTML = `
                    <div class="card product-card not-found-card">
                        <div class="card-body text-center">
                            <div class="py-4">
                                <i class="fas fa-exclamation-triangle not-found-icon mb-3"></i>
                                <h5 class="card-title not-found-title">Article Not Found</h5>
                                ${searchTermBadge}
                                <p class="card-text not-found-message">
                                    ${product.notFoundMessage || 'This article was not found. It may not be published yet or could be a typo.'}
                                </p>
                            </div>
                        </div>
                        <div class="card-footer bg-white">
                            <small class="text-muted">Search term: ${product.searchTerm || 'N/A'}</small>
                        </div>
                    </div>
                `;

                return notFoundCard;
            }

            function exportToExcel(option = 'all') {
                if (!allSearchResults || allSearchResults.length === 0) {
                    alert('No results to export');
                    return;
                }

                // Filter products based on the selected option
                let productsToExport;
                
                switch (option) {
                    case 'found':
                        productsToExport = allSearchResults.filter(p => p.found === true);
                        break;
                    case 'notFound':
                        productsToExport = allSearchResults.filter(p => p.found === false);
                        break;
                    case 'available':
                        productsToExport = allSearchResults.filter(p => p.found === true && p.available === true);
                        break;
                    case 'unavailable':
                        productsToExport = allSearchResults.filter(p => p.found === true && p.available === false);
                        break;
                    case 'currentView':
                        // Get currently visible products based on the applied filter
                        const visibleIds = Array.from(document.querySelectorAll('.col-md-4[style="display: block;"]'))
                            .map(col => {
                                const productCard = col.querySelector('.product-card');
                                if (productCard.classList.contains('not-found-card')) {
                                    // Not found products - get searchTerm
                                    const searchTerm = col.id.replace('not-found-', '');
                                    return { type: 'notFound', term: searchTerm };
                                } else {
                                    // Found products - get ID
                                    const id = col.id.replace('product-', '');
                                    return { type: 'found', id: id };
                                }
                            });
                            
                        productsToExport = allSearchResults.filter(product => {
                            if (product.found === false) {
                                return visibleIds.some(item => 
                                    item.type === 'notFound' && item.term === product.searchTerm);
                            } else {
                                const productId = product.retailerProductId || product.productId || product.searchTerm;
                                return visibleIds.some(item => 
                                    item.type === 'found' && item.id === productId);
                            }
                        });
                        break;
                    default:
                        // 'all' - export everything
                        productsToExport = allSearchResults;
                }

                // Create a new workbook
                const wb = XLSX.utils.book_new();

                // Prepare data for export - create a flat array of data
                const exportData = productsToExport.map(product => {
                    // Format offers for Excel
                    let sceneOffers = '';
                    let otherOffers = '';

                    if (product.offers && product.offers.length > 0) {
                        product.offers.forEach(offer => {
                            const offerText = offer.description || offer.promotionText || '';
                            if (offerText && offerText.includes('SCENE+')) {
                                sceneOffers += (sceneOffers ? ', ' : '') + offerText;
                            } else if (offerText) {
                                otherOffers += (otherOffers ? ', ' : '') + offerText;
                            }
                        });
                    }

                    // Calculate discount percentage if not already done
                    let discountPercentage = product.discountPercentage;
                    if (!discountPercentage && product.originalPrice && product.currentPrice) {
                        try {
                            const current = parseFloat(product.currentPrice);
                            const original = parseFloat(product.originalPrice);
                            if (original > current) {
                                discountPercentage = Math.round(
                                    ((original - current) / original) * 100
                                );
                            }
                        } catch (e) {
                            // Ignore calculation errors
                        }
                    }

                    // Check if this is a not found product
                    if (product.found === false) {
                        return {
                            "Search Term": product.searchTerm || 'N/A',
                            "Product ID": 'NOT_FOUND',
                            "Name": `Article Not Found: ${product.searchTerm || ''}`,
                            "Brand": 'N/A',
                            "Category": 'N/A',
                            "Current Price": 'N/A',
                            "Original Price": 'N/A',
                            "Discount %": 'N/A',
                            "Unit Price": 'N/A',
                            "Unit": 'N/A',
                            "Available": 'No',
                            "Scene+ Offers": 'N/A',
                            "Other Offers": 'N/A',
                            "Image URL": 'N/A',
                            "Not Found Reason": product.notFoundMessage || 'Article not published or typo'
                        };
                    }

                    // Return formatted row for normal product
                    return {
                        "Search Term": product.searchTerm || 'N/A',
                        "Product ID": product.retailerProductId || product.productId || 'N/A',
                        "Name": product.name || 'N/A',
                        "Brand": product.brand || 'N/A',
                        "Category": product.category || 'N/A',
                        "Current Price": product.currentPrice ? `$${product.currentPrice}` : 'N/A',
                        "Original Price": product.originalPrice ? `$${product.originalPrice}` : 'N/A',
                        "Discount %": discountPercentage ? `${discountPercentage}%` : 'N/A',
                        "Unit Price": product.unitPrice ? `$${product.unitPrice}` : 'N/A',
                        "Unit": product.unitLabel || 'N/A',
                        "Available": product.available ? 'Yes' : 'No',
                        "Scene+ Offers": sceneOffers || 'None',
                        "Other Offers": otherOffers || 'None',
                        "Image URL": product.imageUrl || 'N/A',
                        "Not Found Reason": ''
                    };
                });

                // Convert to worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);

                // Create column widths
                const wscols = [
                    {wch: 20}, // Search Term
                    {wch: 15}, // Product ID
                    {wch: 40}, // Name
                    {wch: 15}, // Brand
                    {wch: 25}, // Category
                    {wch: 15}, // Current Price
                    {wch: 15}, // Original Price
                    {wch: 12}, // Discount %
                    {wch: 15}, // Unit Price
                    {wch: 10}, // Unit
                    {wch: 10}, // Available
                    {wch: 30}, // Scene+ Offers
                    {wch: 30}, // Other Offers
                    {wch: 50}, // Image URL
                    {wch: 40}  // Not Found Reason
                ];

                ws['!cols'] = wscols;

                // Add the worksheet to the workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Products');

                // Get timestamp for filename
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

                // Get region info for filename
                const regionName = currentRegionInfo?.nickname || 'Unknown';
                const postalCode = currentRegionInfo?.postalCode || '';
                
                // Add export type to filename
                let exportTypeLabel = '';
                switch (option) {
                    case 'found': exportTypeLabel = '-Found'; break;
                    case 'notFound': exportTypeLabel = '-NotFound'; break;
                    case 'available': exportTypeLabel = '-Available'; break;
                    case 'unavailable': exportTypeLabel = '-Unavailable'; break;
                    case 'currentView': exportTypeLabel = '-Filtered'; break;
                }

                // Create a descriptive filename with region details
                const filename = `Voila-${regionName}-${postalCode}${exportTypeLabel}-Products-${timestamp}.xlsx`;

                // Generate Excel file
                XLSX.writeFile(wb, filename);
            }
        });
    </script>
</body>
</html>
