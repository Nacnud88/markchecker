<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voila Price Checker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Favicon links -->
<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon_io/apple-touch-icon.png') }}">
<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon_io/favicon-32x32.png') }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon_io/favicon-16x16.png') }}">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon_io/favicon.ico') }}">
<link rel="manifest" href="{{ url_for('static', filename='favicon_io/site.webmanifest') }}">

<style>
    :root {
        --voila-cyan: #00d9f9;
        --voila-dark-green: #00483b;
        --voila-orange: #fc6c2b;
        --voila-white: #ffffff;
        --voila-very-dark-green: #002f2c;
        --voila-muted-teal: #2a6762;
        --voila-light-bg: #f8f9fa;
        --voila-gray: #6c757d;
        --voila-red: #dc3545;
        --voila-light-red: #f8d7da;
        --voila-dark-red: #842029;
        --voila-yellow: #ffc107;
        --voila-light-yellow: #fff3cd;
        --voila-blue: #0d6efd;
        --voila-light-blue: #cfe2ff;
    }

    body {
        padding-bottom: 40px;
        margin: 0;
        background-color: var(--voila-light-bg);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: var(--voila-very-dark-green);
    }

    .container {
        max-width: 1200px;
    }

    /* Navigation Bar Styles */
    .navbar {
        background-color: var(--voila-very-dark-green);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 1rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 10px 10px;
    }

    .navbar-brand {
        font-weight: bold;
        color: var(--voila-cyan) !important;
    }

    .logo-text {
        font-size: 2.2rem;
        font-weight: 800;
        letter-spacing: -1px;
    }

    .brand-subtitle {
        color: var(--voila-white);
        font-size: 0.9rem;
        opacity: 0.9;
        letter-spacing: 0.5px;
    }
    
    /* Tab Navigation */
    .nav-tabs {
        margin-bottom: 20px;
        border-bottom: 2px solid var(--voila-dark-green);
    }
    
    .nav-tabs .nav-link {
        color: var(--voila-dark-green);
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        margin-right: 10px;
        border-radius: 0;
        transition: all 0.2s ease;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: transparent;
        background-color: rgba(0, 72, 59, 0.05);
    }
    
    .nav-tabs .nav-link.active {
        color: var(--voila-dark-green);
        background-color: transparent;
        border-bottom: 3px solid var(--voila-cyan);
        font-weight: 600;
    }

    /* Product Card Styles */
    .product-card {
        margin-bottom: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%;
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.07);
        border: none;
        overflow: hidden;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
    }

    .product-img {
        height: 200px;
        object-fit: contain;
        padding: 10px;
        transition: transform 0.3s ease;
    }

    .product-card:hover .product-img {
        transform: scale(1.05);
    }

    /* Not Found Card Styles */
    .not-found-card {
        background-color: var(--voila-light-red);
        border-left: 5px solid var(--voila-red);
    }

    .not-found-icon {
        font-size: 4rem;
        color: var(--voila-red);
        opacity: 0.7;
    }

    .not-found-title {
        font-weight: 600;
        color: var(--voila-dark-red);
    }

    .not-found-message {
        color: var(--voila-dark-red);
    }

    /* Session ID Section */
    .session-id-section {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid var(--voila-cyan);
        transition: all 0.3s ease;
    }

    .session-id-section:focus-within {
        box-shadow: 0 0 0 0.25rem rgba(0, 217, 249, 0.25);
        border-color: var(--voila-dark-green);
    }

    /* Region Info Banner */
    .region-info-banner {
        background-color: var(--voila-dark-green);
        color: var(--voila-white);
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        border-left: 4px solid var(--voila-cyan);
        animation: fadeIn 0.5s ease;
    }

    .region-icon {
        font-size: 1.5rem;
        margin-right: 15px;
        color: var(--voila-cyan);
    }

    /* Instructions */
    .instructions {
        background-color: #fff;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid var(--voila-dark-green);
    }

    /* Price Tag Styles */
    .price-tag {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--voila-dark-green);
    }

    .original-price {
        text-decoration: line-through;
        color: var(--voila-gray);
        font-size: 0.9rem;
    }

    .discount-badge {
        background-color: var(--voila-orange) !important;
        color: white;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 0.8rem;
        margin-left: 5px;
        font-weight: bold;
    }

    .scene-badge {
        background-color: #6f42c1;
        color: white;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 0.8rem;
        margin-right: 5px;
        margin-bottom: 5px;
        display: inline-block;
    }

    .offer-badge {
        background-color: var(--voila-orange);
        color: white;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 0.8rem;
        margin-right: 5px;
        margin-bottom: 5px;
        display: inline-block;
    }

    /* Search Container */
    .search-container {
        background-color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .search-container:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    /* Loading Spinner */
    .loading-spinner {
        display: none;
        text-align: center;
        margin: 20px 0;
        padding: 20px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        animation: fadeIn 0.5s ease;
    }

    /* Progress Bar */
    .progress-container {
        margin-top: 15px;
        display: none;
        animation: fadeIn 0.5s ease;
    }

    .progress {
        height: 24px;
        border-radius: 10px;
        overflow: hidden;
        background-color: #e9ecef;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
        background-color: var(--voila-dark-green);
        color: var(--voila-white);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        font-weight: 600;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        transition: width 0.3s ease;
    }

    .progress-status {
        margin-top: 8px;
        font-size: 0.9rem;
        color: var(--voila-dark-green);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .progress-details {
        font-size: 0.8rem;
        color: var(--voila-gray);
    }
    
    /* Batch Progress */
    .batch-progress {
        margin-top: 10px;
        animation: fadeIn 0.5s ease;
    }
    
    .progress-item-details {
        margin-top: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border-left: 3px solid var(--voila-cyan);
        animation: fadeIn 0.5s ease;
        transition: all 0.3s ease;
    }
    
    .progress-item-details:hover {
        background-color: #f1f3f5;
        border-left-width: 5px;
    }
    
    .progress-item-name {
        font-weight: 600;
        color: var(--voila-dark-green);
        margin-bottom: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .progress-item-info {
        font-size: 0.9rem;
        color: var(--voila-gray);
        padding: 8px;
        background: #fff;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .progress-metrics {
        display: flex;
        justify-content: space-between;
        margin: 15px 0;
        gap: 10px;
    }
    
    .progress-metric {
        text-align: center;
        background: #fff;
        padding: 12px 10px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        flex: 1;
        min-width: 80px;
        transition: all 0.2s ease;
    }
    
    .progress-metric:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    
    .progress-metric-value {
        font-weight: bold;
        font-size: 1.3rem;
        color: var(--voila-dark-green);
    }
    
    .progress-metric-label {
        font-size: 0.8rem;
        color: var(--voila-gray);
        margin-top: 5px;
    }

    /* Duplicate Message */
    .duplicate-message {
        background-color: var(--voila-light-yellow);
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        border-left: 4px solid var(--voila-yellow);
        animation: fadeIn 0.5s ease;
    }
    
    .duplicate-list {
        max-height: 150px;
        overflow-y: auto;
        font-size: 0.9rem;
        padding: 10px;
        background: #fff;
        border-radius: 5px;
        margin-top: 8px;
        border: 1px solid rgba(0,0,0,0.1);
    }

    /* Form Elements Styles */
    .form-control {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: var(--voila-muted-teal);
        box-shadow: 0 0 0 0.25rem rgba(0, 217, 249, 0.25);
    }

    .form-label {
        font-weight: 500;
        color: var(--voila-dark-green);
        margin-bottom: 0.5rem;
    }
    
    /* Clean button */
    .clear-search-wrapper {
        position: relative;
    }
    
    #clearSearchButton {
        position: absolute;
        right: 10px;
        top: 10px;
        background: rgba(255,255,255,0.8);
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--voila-gray);
        padding: 0;
        transition: all 0.2s ease;
        z-index: 5;
    }
    
    #clearSearchButton:hover {
        background: rgba(220,53,69,0.1);
        color: var(--voila-red);
    }
    
    /* Search Type Toggle */
    .search-type-toggle {
        margin-bottom: 20px;
    }
    
    .search-type-toggle .btn-check:checked + .btn {
        background-color: var(--voila-dark-green);
        color: white;
        border-color: var(--voila-dark-green);
    }
    
    .search-type-toggle .btn {
        border-color: var(--voila-dark-green);
        color: var(--voila-dark-green);
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .search-type-toggle .btn:hover {
        background-color: rgba(0, 72, 59, 0.1);
        transform: translateY(-1px);
    }
    
    .search-type-toggle .btn i {
        margin-right: 8px;
    }
    
    .search-placeholder {
        font-style: italic;
        color: #adb5bd;
        font-size: 0.85rem;
        margin-top: 5px;
    }

    /* Button Styles */
    .btn-primary {
        background-color: var(--voila-dark-green);
        border-color: var(--voila-dark-green);
        padding: 0.6rem 1.2rem;
        font-weight: 500;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .btn-primary:hover, .btn-primary:focus {
        background-color: var(--voila-muted-teal);
        border-color: var(--voila-muted-teal);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-success {
        background-color: var(--voila-muted-teal);
        border-color: var(--voila-muted-teal);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .btn-success:hover, .btn-success:focus {
        background-color: #225752;
        border-color: #225752;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Cancel button */
    .btn-outline-danger {
        transition: all 0.2s ease;
    }
    
    .btn-outline-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Results Section */
    .results-card {
        overflow: visible;
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.07);
        margin-bottom: 20px;
        animation: fadeIn 0.5s ease;
    }

    .results-header {
        background-color: var(--voila-dark-green);
        color: var(--voila-white);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-radius: 12px 12px 0 0;
    }

    .results-header h5 {
        margin-bottom: 0;
        font-weight: 600;
    }

    .parsed-terms {
        background-color: #e9ecef;
        padding: 10px 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        border-left: 4px solid var(--voila-muted-teal);
        max-height: 300px;
        overflow-y: auto;
    }

    .parsed-terms h6 {
        color: var(--voila-dark-green);
        margin-bottom: 10px;
    }

    .parsed-terms ul {
        margin-bottom: 0;
        padding-left: 20px;
    }

    .parsed-terms-toggle {
        cursor: pointer;
        color: var(--voila-muted-teal);
        text-decoration: underline;
    }

    /* Filter Controls */
    .filter-controls {
        background-color: #f1f3f5;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        animation: fadeIn 0.5s ease;
        border-left: 3px solid var(--voila-dark-green);
    }

    .filter-label {
        font-weight: 600;
        margin-right: 10px;
        color: var(--voila-dark-green);
    }
    
    .filter-btn-group {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 8px;
    }
    
    .filter-btn-group .btn {
        flex: 1;
        min-width: 100px;
        margin-bottom: 5px;
    }
    
    /* Export Modal */
    .modal-header {
        background-color: var(--voila-dark-green);
        color: white;
    }
    
    .modal-header .btn-close {
        filter: invert(1) brightness(200%);
    }
    
    .export-option {
        margin-bottom: 10px;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        transition: all 0.2s;
    }
    
    .export-option:hover {
        background-color: #f8f9fa;
        border-color: var(--voila-cyan);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    
    .export-option input {
        margin-right: 10px;
    }
    
    .export-option label {
        width: 100%;
        cursor: pointer;
        margin-bottom: 0;
        display: flex;
        align-items: center;
    }
    
    /* Alerts */
    .alert {
        border-radius: 8px;
        animation: fadeIn 0.5s ease;
    }
    
    /* Animations */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 72, 59, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(0, 72, 59, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(0, 72, 59, 0);
        }
    }

    /* Mobile Responsiveness */
    @media (max-width: 767.98px) {
        .card-header {
            padding: 0.85rem 1.25rem;
        }

        .card-body {
            padding: 1.25rem;
        }

        .logo-text {
            font-size: 1.8rem;
        }

        .results-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .export-btn {
            align-self: flex-start;
        }
        
        .progress-metrics {
            flex-direction: column;
            gap: 8px;
        }
        
        .progress-metric {
            width: 100%;
        }
        
        .search-type-toggle .btn {
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        
        .search-placeholder {
            font-size: 0.8rem;
        }
        
        .nav-tabs .nav-link {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .filter-btn-group {
            flex-direction: column;
        }
        
        .filter-btn-group .btn {
            width: 100%;
            margin-bottom: 5px;
        }
    }
    
    /* Dark mode for system preference */
    @media (prefers-color-scheme: dark) {
        .dark-mode-toggle {
            display: block;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--voila-dark-green);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .dark-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
    }
    
    /* Hover effects */
    .card {
        transition: all 0.3s ease;
    }
    
    .card:hover {
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    /* Tooltip Styles */
    .tooltip-inner {
        background-color: var(--voila-dark-green);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-width: 300px;
        padding: 10px 15px;
        border-radius: 5px;
        font-size: 0.9rem;
    }
    
    .bs-tooltip-auto[data-popper-placement^=top] .tooltip-arrow::before, 
    .bs-tooltip-top .tooltip-arrow::before {
        border-top-color: var(--voila-dark-green);
    }
</style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <span class="logo-text"><i class="fas fa-shopping-cart me-2"></i>voilà 🍑</span>
                <small class="d-block brand-subtitle">Regional Price Checker</small>
            </a>
        </div>
    </nav>
<div class="container">
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-tab-pane" type="button" role="tab" aria-controls="search-tab-pane" aria-selected="true">
                <i class="fas fa-search me-2"></i>Search
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="instructions-tab" data-bs-toggle="tab" data-bs-target="#instructions-tab-pane" type="button" role="tab" aria-controls="instructions-tab-pane" aria-selected="false">
                <i class="fas fa-info-circle me-2"></i>Instructions
            </button>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="myTabContent">
        <!-- Search Tab -->
        <div class="tab-pane fade show active" id="search-tab-pane" role="tabpanel" aria-labelledby="search-tab" tabindex="0">
            <!-- Session ID Input -->
            <div class="search-container">
                <div class="session-id-section">
                    <div class="mb-3">
                        <label for="sessionId" class="form-label">
                            <i class="fas fa-key me-2"></i>Voila Session ID:
                            <span class="badge bg-info ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Log in to Voila.ca, open developer tools (F12), go to Application tab, find 'global_sid' cookie and copy its value">
                                <i class="fas fa-info-circle"></i> How to get it
                            </span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user-lock"></i></span>
                            <input type="text" class="form-control" id="sessionId" placeholder="Paste your global_sid here">
                            <button class="btn btn-outline-secondary" type="button" id="checkRegionButton">
                                <i class="fas fa-map-marker-alt me-1"></i> Check Region
                            </button>
                        </div>
                        <small class="form-text text-muted mt-1">
                            <i class="fas fa-shield-alt me-1"></i> Your session ID is only used to query Voila's API and is not stored
                        </small>
                    </div>
                </div>

                <!-- Region Info Banner (Initially Hidden) -->
                <div id="regionInfoBanner" class="region-info-banner" style="display: none;">
                    <i class="fas fa-map-marker-alt region-icon"></i>
                    <div id="regionText"></div>
                </div>

                <!-- Duplicate Message (Initially Hidden) -->
                <div id="duplicateMessage" class="duplicate-message" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clone me-2"></i>
                        <span id="duplicateText"></span>
                    </div>
                    <div id="duplicateList" class="duplicate-list mt-2" style="display: none;"></div>
                    <button id="toggleDuplicateList" class="btn btn-sm btn-outline-warning mt-2" style="display: none;">
                        <i class="fas fa-eye me-1"></i> Show Duplicates
                    </button>
                </div>
                
                <!-- Search Type Toggle -->
                <div class="search-type-toggle mb-4">
                    <div class="form-label mb-2">
                        <i class="fas fa-filter me-2"></i>Search Type:
                    </div>
                    <div class="btn-group w-100" role="group" aria-label="Search type">
                        <input type="radio" class="btn-check" name="searchType" id="articleSearch" value="article" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="articleSearch">
                            <i class="fas fa-barcode"></i> Article Search
                            <div class="search-placeholder">Search for specific article codes (e.g. 123456EA)</div>
                        </label>

                        <input type="radio" class="btn-check" name="searchType" id="genericSearch" value="generic" autocomplete="off">
                        <label class="btn btn-outline-primary" for="genericSearch">
                            <i class="fas fa-search"></i> Generic Search
                            <div class="search-placeholder">Search for general terms (e.g. Water, Coffee)</div>
                        </label>
                    </div>
                </div>

                <!-- Search Form -->
                <div class="mb-3 position-relative">
                    <label for="searchTerms" class="form-label">
                        <span id="searchTermsLabel">Article Codes:</span>
                    </label>
                    <div class="clear-search-wrapper">
                        <textarea class="form-control" id="searchTerms" rows="6" placeholder="Paste article codes in any format (comma-separated, one per line, etc.)"></textarea>
                        <button type="button" id="clearSearchButton" class="btn-close" aria-label="Clear search"></button>
                    </div>
                </div>
                
                <!-- Generic Search Options (Initially Hidden) -->
                <div id="genericSearchOptions" class="mb-3" style="display: none;">
                    <label for="resultLimit" class="form-label">
                        <i class="fas fa-list-ol me-1"></i> Results per Search Term:
                    </label>
                    <select class="form-select" id="resultLimit">
                        <option value="5">5 results per term</option>
                        <option value="10" selected>10 results per term</option>
                        <option value="20">20 results per term</option>
                        <option value="50">50 results per term (maximum)</option>
                    </select>
                </div>
                
                <!-- Button Group -->
                <div class="d-flex gap-2">
                    <button id="searchButton" class="btn btn-primary flex-grow-1 mb-3">
                        <i class="fas fa-search me-2"></i>Search Products
                    </button>
                    <button id="clearAllButton" class="btn btn-outline-secondary mb-3">
                        <i class="fas fa-trash-alt me-2"></i>Clear All
                    </button>
                </div>
                <button id="exportButton" class="btn btn-success w-100" style="display: none;">
                    <i class="fas fa-file-export me-2"></i>Export to Excel
                </button>
            </div>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2" id="loadingMessage">Searching products...</p>
                
                <!-- Enhanced Progress Bar -->
                <div class="progress-container" id="progressContainer">
                    <!-- Overall Progress -->
                    <div class="progress mb-2">
                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <div class="progress-status" id="progressStatus">
                        <span id="progressStatusText">Initializing search...</span>
                        <span id="progressTimeRemaining"></span>
                    </div>
                    
                    <!-- Batch Progress -->
                    <div class="batch-progress mt-3 mb-3" id="batchProgressContainer" style="display: none;">
                        <div class="d-flex justify-content-between">
                            <span class="small text-muted">Current Batch Progress:</span>
                            <span class="small text-muted" id="batchProgressLabel">Batch 0/0</span>
                        </div>
                        <div class="progress" style="height: 12px;">
                            <div class="progress-bar bg-info" id="batchProgressBar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    
                    <!-- Progress Metrics -->
                    <div class="progress-metrics">
                        <div class="progress-metric">
                            <div class="progress-metric-value" id="progressProcessed">0</div>
                            <div class="progress-metric-label">Processed</div>
                        </div>
                        <div class="progress-metric">
                            <div class="progress-metric-value" id="progressTotal">0</div>
                            <div class="progress-metric-label">Total Items</div>
                        </div>
                        <div class="progress-metric">
                            <div class="progress-metric-value" id="progressFound">0</div>
                            <div class="progress-metric-label">Found</div>
                        </div>
                        <div class="progress-metric">
                            <div class="progress-metric-value" id="progressNotFound">0</div>
                            <div class="progress-metric-label">Not Found</div>
                        </div>
                    </div>
                    
                    <!-- Current Item Details -->
                    <div class="progress-item-details" id="currentItemDetails" style="display: none;">
                        <div class="progress-item-name" id="currentItemName">Processing: </div>
                        <div class="progress-item-info" id="currentItemInfo"></div>
                    </div>
                    
                    <!-- Cancel Button -->
                    <div class="text-center mt-3">
                        <button class="btn btn-sm btn-outline-danger" id="cancelSearchButton">
                            <i class="fas fa-times-circle me-1"></i> Cancel Search
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="searchInfo" class="results-card" style="display: none;">
                <div class="results-header">
                    <h5 id="searchResultsTitle">Search Results</h5>
                    <span id="resultStats" class="badge bg-light text-dark"></span>
                </div>
                <div class="card-body">
                    <!-- Parsed Terms Section (Initially Hidden) -->
                    <div id="parsedTermsSection" class="parsed-terms" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Parsed Search Terms</h6>
                            <span id="hideTermsToggle" class="parsed-terms-toggle">
                                <i class="fas fa-eye-slash me-1"></i>Hide
                            </span>
                        </div>
                        <div id="parsedTermsList" class="mt-2"></div>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div id="filterControls" class="filter-controls" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="filter-label mb-1">
                                <i class="fas fa-filter me-2"></i>Show:
                            </div>
                            <button id="resetFilters" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-undo me-1"></i>Reset Filters
                            </button>
                        </div>
                        
                        <div class="filter-btn-group">
                            <input type="radio" class="btn-check" name="productFilter" id="filterAll" autocomplete="off" checked>
                            <label class="btn btn-outline-secondary" for="filterAll">
                                <i class="fas fa-border-all me-1"></i>All Products
                            </label>
                            
                            <input type="radio" class="btn-check" name="productFilter" id="filterFound" autocomplete="off">
                            <label class="btn btn-outline-success" for="filterFound">
                                <i class="fas fa-check-circle me-1"></i>Found Products
                            </label>
                            
                            <input type="radio" class="btn-check" name="productFilter" id="filterNotFound" autocomplete="off">
                            <label class="btn btn-outline-danger" for="filterNotFound">
                                <i class="fas fa-times-circle me-1"></i>Not Found
                            </label>
                            
                            <input type="radio" class="btn-check" name="productFilter" id="filterAvailable" autocomplete="off">
                            <label class="btn btn-outline-primary" for="filterAvailable">
                                <i class="fas fa-shopping-basket me-1"></i>Available
                            </label>
                            
                            <input type="radio" class="btn-check" name="productFilter" id="filterUnavailable" autocomplete="off">
                            <label class="btn btn-outline-warning" for="filterUnavailable">
                                <i class="fas fa-ban me-1"></i>Unavailable
                            </label>
                            
                            <input type="radio" class="btn-check" name="productFilter" id="filterDiscounted" autocomplete="off">
                            <label class="btn btn-outline-info" for="filterDiscounted">
                                <i class="fas fa-tag me-1"></i>Discounted
                            </label>
                        </div>
                        
                        <!-- Sort Options -->
                        <div class="mt-3">
                            <div class="filter-label mb-1">
                                <i class="fas fa-sort me-2"></i>Sort By:
                            </div>
                            <select class="form-select" id="sortOptions">
                                <option value="default">Default Order</option>
                                <option value="priceAsc">Price: Low to High</option>
                                <option value="priceDesc">Price: High to Low</option>
                                <option value="discountDesc">Discount: Highest First</option>
                                <option value="nameAsc">Name: A to Z</option>
                                <option value="nameDesc">Name: Z to A</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="resultsContainer" class="row"></div>
                    
                    <!-- No Results Message -->
                    <div id="noResultsMessage" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No products match the current filter. Try changing your filter criteria.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Instructions Tab -->
        <div class="tab-pane fade" id="instructions-tab-pane" role="tabpanel" aria-labelledby="instructions-tab" tabindex="0">
            <div class="instructions">
                <h4><i class="fas fa-info-circle me-2"></i>How to Use the Voila Price Checker</h4>
                <p>This tool allows you to search for products on Voila.ca using your personal session ID in two different ways:</p>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-barcode me-2"></i>Article Search</h5>
                    </div>
                    <div class="card-body">
                        <p>Use this mode when you have specific article codes or product IDs to look up.</p>
                        <ol>
                            <li>Enter your Voila session ID</li>
                            <li>Select "Article Search" mode</li>
                            <li>Paste a list of article codes in any format (comma-separated, one per line, etc.)</li>
                            <li>Click "Search Products"</li>
                        </ol>
                        <div class="alert alert-info">
                            <strong>Article Code Formats:</strong> The tool automatically detects and parses article codes in various formats:
                            <ul>
                                <li>Comma-separated: <code>123456EA, 789012EA</code></li>
                                <li>One code per line (as copied from Excel)</li>
                                <li>Space-separated: <code>123456EA 789012EA</code></li>
                                <li>Continuous list: <code>123456EA789012EA</code> will be automatically parsed</li>
                            </ul>
                            Duplicate codes will be automatically detected and removed.
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-search me-2"></i>Generic Search</h5>
                    </div>
                    <div class="card-body">
                        <p>Use this mode when you want to search for general terms like "Water" or "Coffee".</p>
                        <ol>
                            <li>Enter your Voila session ID</li>
                            <li>Select "Generic Search" mode</li>
                            <li>Enter a search term</li>
                            <li>Choose how many results you want per term (up to 50)</li>
                            <li>Click "Search Products"</li>
                        </ol>
                        <div class="alert alert-warning">
                            Generic searches will return multiple matching products per term, up to the limit you specify.
                        </div>
                    </div>
                </div>

                <h5 class="mt-3"><i class="fas fa-key me-2"></i>How to Get Your Session ID:</h5>
                <ol>
                    <li>Log in to your Voila.ca account</li>
                    <li>Book a time in the region you want to search</li>
                    <li>Open your browser's developer tools (F12 or right-click and select "Inspect")</li>
                    <li>Go to the "Application" or "Storage" tab</li>
                    <li>Look for "Cookies" and find the "global_sid" cookie value</li>
                    <li>Copy the entire value and paste it in the Session ID field</li>
                </ol>
                
                <h5 class="mt-3"><i class="fas fa-star me-2"></i>Features:</h5>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-group mb-3">
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-chart-line text-primary me-2"></i>
                                <div>
                                    <strong>Progress Tracking</strong>
                                    <div class="small text-muted">For large batches, you'll see detailed progress information</div>
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-filter text-success me-2"></i>
                                <div>
                                    <strong>Advanced Filtering</strong>
                                    <div class="small text-muted">Filter results by availability, discount, and more</div>
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-file-export text-info me-2"></i>
                                <div>
                                    <strong>Export to Excel</strong>
                                    <div class="small text-muted">Export your search results with various filtering options</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group">
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-clone text-warning me-2"></i>
                                <div>
                                    <strong>Duplicate Detection</strong>
                                    <div class="small text-muted">Automatic detection and removal of duplicate search terms</div>
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-sort-amount-down text-danger me-2"></i>
                                <div>
                                    <strong>Sorting Options</strong>
                                    <div class="small text-muted">Sort by price, name, or discount percentage</div>
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-mobile-alt text-secondary me-2"></i>
                                <div>
                                    <strong>Mobile Friendly</strong>
                                    <div class="small text-muted">Works well on smartphones and tablets</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="alert alert-danger mt-3">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Important:</strong> This tool uses your personal Voila session for API requests. Your session ID is never stored or shared, but be aware that using the tool will count as activity on your Voila account.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Options Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">
                    <i class="fas fa-file-export me-2"></i>Export Options
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Select what to include in the export:</p>
                
                <div class="export-option">
                    <input type="radio" name="exportOption" id="exportAll" checked>
                    <label for="exportAll">
                        <i class="fas fa-border-all text-primary me-2"></i>
                        <span>
                            <strong>All Products</strong>
                            <div class="small text-muted">Export all found and not found products</div>
                        </span>
                    </label>
                </div>
                
                <div class="export-option">
                    <input type="radio" name="exportOption" id="exportFound">
                    <label for="exportFound">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span>
                            <strong>Found Products Only</strong>
                            <div class="small text-muted">Export only products that were found</div>
                        </span>
                    </label>
                </div>
                
                <div class="export-option">
                    <input type="radio" name="exportOption" id="exportNotFound">
                    <label for="exportNotFound">
                        <i class="fas fa-times-circle text-danger me-2"></i>
                        <span>
                            <strong>Not Found Products Only</strong>
                            <div class="small text-muted">Export only products that were not found</div>
                        </span>
                    </label>
                </div>
                
                <div class="export-option">
                    <input type="radio" name="exportOption" id="exportAvailable">
                    <label for="exportAvailable">
                        <i class="fas fa-shopping-basket text-info me-2"></i>
                        <span>
                            <strong>Available Products Only</strong>
                            <div class="small text-muted">Export only products that are available</div>
                        </span>
                    </label>
                </div>
                
                <div class="export-option">
                    <input type="radio" name="exportOption" id="exportUnavailable">
                    <label for="exportUnavailable">
                        <i class="fas fa-ban text-warning me-2"></i>
                        <span>
                            <strong>Unavailable Products Only</strong>
                            <div class="small text-muted">Export only products that are unavailable</div>
                        </span>
                    </label>
                </div>
                
                <div class="export-option">
                    <input type="radio" name="exportOption" id="exportCurrentView">
                    <label for="exportCurrentView">
                        <i class="fas fa-filter text-secondary me-2"></i>
                        <span>
                            <strong>Current View (As Filtered)</strong>
                            <div class="small text-muted">Export only products matching current filters</div>
                        </span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-success" id="confirmExport">
                    <i class="fas fa-file-export me-1"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables
        const searchButton = document.getElementById('searchButton');
        const exportButton = document.getElementById('exportButton');
        const confirmExportButton = document.getElementById('confirmExport');
        const clearSearchButton = document.getElementById('clearSearchButton');
        const clearAllButton = document.getElementById('clearAllButton');
        const cancelSearchButton = document.getElementById('cancelSearchButton');
        const checkRegionButton = document.getElementById('checkRegionButton');
        const resetFiltersButton = document.getElementById('resetFilters');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadingMessage = document.getElementById('loadingMessage');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressStatusText = document.getElementById('progressStatusText');
        const progressTimeRemaining = document.getElementById('progressTimeRemaining');
        const progressProcessed = document.getElementById('progressProcessed');
        const progressTotal = document.getElementById('progressTotal');
        const progressFound = document.getElementById('progressFound');
        const progressNotFound = document.getElementById('progressNotFound');
        const batchProgressContainer = document.getElementById('batchProgressContainer');
        const batchProgressBar = document.getElementById('batchProgressBar');
        const batchProgressLabel = document.getElementById('batchProgressLabel');
        const currentItemDetails = document.getElementById('currentItemDetails');
        const currentItemName = document.getElementById('currentItemName');
        const currentItemInfo = document.getElementById('currentItemInfo');
        const resultsContainer = document.getElementById('resultsContainer');
        const searchInfo = document.getElementById('searchInfo');
        const resultStats = document.getElementById('resultStats');
        const searchResultsTitle = document.getElementById('searchResultsTitle');
        const regionInfoBanner = document.getElementById('regionInfoBanner');
        const regionText = document.getElementById('regionText');
        const parsedTermsSection = document.getElementById('parsedTermsSection');
        const parsedTermsList = document.getElementById('parsedTermsList');
        const hideTermsToggle = document.getElementById('hideTermsToggle');
        const filterControls = document.getElementById('filterControls');
        const duplicateMessage = document.getElementById('duplicateMessage');
        const duplicateText = document.getElementById('duplicateText');
        const duplicateList = document.getElementById('duplicateList');
        const toggleDuplicateList = document.getElementById('toggleDuplicateList');
        const searchTermsLabel = document.getElementById('searchTermsLabel');
        const searchTerms = document.getElementById('searchTerms');
        const genericSearchOptions = document.getElementById('genericSearchOptions');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const sortOptions = document.getElementById('sortOptions');
        
        // Search type radio buttons
        const articleSearch = document.getElementById('articleSearch');
        const genericSearch = document.getElementById('genericSearch');
        
        // Filter options
        const filterAll = document.getElementById('filterAll');
        const filterFound = document.getElementById('filterFound');
        const filterNotFound = document.getElementById('filterNotFound');
        const filterAvailable = document.getElementById('filterAvailable');
        const filterUnavailable = document.getElementById('filterUnavailable');
        const filterDiscounted = document.getElementById('filterDiscounted');

        // Export modal
        const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));

        // Store results for export
        let allSearchResults = [];
        let totalFoundProducts = 0;
        let displayedProducts = 0;
        let notFoundProducts = 0;
        let currentRegionInfo = null;
        let parsedTerms = [];
        let duplicatesFound = [];
        let isProcessingLargeRequest = false;
        let streamingResponse = null;
        let abortController = null;
        let searchStartTime = null;
        
        // Progress tracking for estimated time
        let progressUpdateTimes = [];
        let progressUpdateValues = [];
        
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Set up event listeners
        searchButton.addEventListener('click', searchProducts);
        clearSearchButton.addEventListener('click', function() {
            searchTerms.value = '';
            searchTerms.focus();
        });
        
        clearAllButton.addEventListener('click', clearAll);
        
        cancelSearchButton.addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel the current search?')) {
                abortCurrentRequest();
                
                // Hide loading UI
                loadingSpinner.style.display = 'none';
                progressContainer.style.display = 'none';
                
                // Show message to user
                resultsContainer.innerHTML = '<div class="col-12"><div class="alert alert-warning">' +
                    '<i class="fas fa-exclamation-triangle me-2"></i> Search was cancelled by user.</div></div>';
                searchInfo.style.display = 'block';
                searchResultsTitle.textContent = 'Search Cancelled';
                resultStats.textContent = '';
            }
        });
        
        checkRegionButton.addEventListener('click', checkRegionInfo);
        
        resetFiltersButton.addEventListener('click', function() {
            filterAll.checked = true;
            sortOptions.value = 'default';
            filterResults();
        });
        
        exportButton.addEventListener('click', function() {
            // Show export modal instead of directly exporting
            exportModal.show();
        });
        
        confirmExportButton.addEventListener('click', function() {
            // Hide the modal
            exportModal.hide();
            
            // Determine which export option was selected
            let option = 'all';
            if (document.getElementById('exportFound').checked) option = 'found';
            else if (document.getElementById('exportNotFound').checked) option = 'notFound';
            else if (document.getElementById('exportAvailable').checked) option = 'available';
            else if (document.getElementById('exportUnavailable').checked) option = 'unavailable';
            else if (document.getElementById('exportCurrentView').checked) option = 'currentView';
            
            // Export with the selected option
            exportToExcel(option);
        });
        
        // Toggle for parsed terms section
        hideTermsToggle.addEventListener('click', function() {
            const termsListDiv = parsedTermsList;
            if (termsListDiv.style.display === 'none') {
                termsListDiv.style.display = 'block';
                this.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide';
            } else {
                termsListDiv.style.display = 'none';
                this.innerHTML = '<i class="fas fa-eye me-1"></i>Show';
            }
        });
        
        // Toggle for duplicate list
        toggleDuplicateList.addEventListener('click', function() {
            if (duplicateList.style.display === 'none') {
                duplicateList.style.display = 'block';
                this.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Hide Duplicates';
            } else {
                duplicateList.style.display = 'none';
                this.innerHTML = '<i class="fas fa-eye me-1"></i> Show Duplicates';
            }
        });
        
        // Search type listeners
        articleSearch.addEventListener('change', updateSearchType);
        genericSearch.addEventListener('change', updateSearchType);
        
        // Sort options listener
        sortOptions.addEventListener('change', function() {
            sortResults(this.value);
        });
        
        function updateSearchType() {
            if (articleSearch.checked) {
                // Article search mode
                searchTermsLabel.innerHTML = '<i class="fas fa-barcode me-2"></i>Article Codes:';
                searchTerms.placeholder = 'Paste article codes in any format (comma-separated, one per line, etc.)';
                genericSearchOptions.style.display = 'none';
            } else {
                // Generic search mode
                searchTermsLabel.innerHTML = '<i class="fas fa-search me-2"></i>Search Terms:';
                searchTerms.placeholder = 'Enter general search terms like "Water" or "Coffee"';
                genericSearchOptions.style.display = 'block';
            }
        }
        
        // Filter event listeners
        [filterAll, filterFound, filterNotFound, filterAvailable, filterUnavailable, filterDiscounted].forEach(
            filter => filter.addEventListener('change', filterResults)
        );

        // Add event listener to check region info when session ID changes
        document.getElementById('sessionId').addEventListener('blur', checkRegionInfo);

        // Also check session ID when pasted
        document.getElementById('sessionId').addEventListener('paste', function() {
            // Short delay to allow paste to complete
            setTimeout(checkRegionInfo, 100);
        });

        // Search when Enter key is pressed in search input while Ctrl is held
        document.getElementById('searchTerms').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                searchProducts();
            }
        });
        
        // Function to clear all results
        function clearAll() {
            // Clear search box
            searchTerms.value = '';
            
            // Reset results
            resultsContainer.innerHTML = '';
            searchInfo.style.display = 'none';
            exportButton.style.display = 'none';
            parsedTermsSection.style.display = 'none';
            filterControls.style.display = 'none';
            duplicateMessage.style.display = 'none';
            noResultsMessage.style.display = 'none';
            
            // Reset global variables
            allSearchResults = [];
            totalFoundProducts = 0;
            displayedProducts = 0;
            notFoundProducts = 0;
            parsedTerms = [];
            duplicatesFound = [];
            
            // Focus on the search box
            searchTerms.focus();
        }

        function handleStreamingResponse(reader, decoder, buffer = "") {
    return reader.read().then(({ done, value }) => {
        if (done) {
            console.log("Stream complete");
            if (buffer.length > 0) {
                try {
                    const jsonData = JSON.parse(buffer);
                    processResults(jsonData);
                } catch (e) {
                    console.error("Error parsing final buffer:", e);
                    console.error("Buffer content:", buffer);
                }
            }
            
            // Hide loading spinner when done
            loadingSpinner.style.display = 'none';
            
            // Update progress bar
            updateProgress(100, "Processing complete!", null, true);
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 2000);
            
            isProcessingLargeRequest = false;
            streamingResponse = null;
            return;
        }
        
        // Decode the current chunk
        const chunk = decoder.decode(value, { stream: true });
        buffer += chunk;
        
        // Look for special progress update markers - these contain product data
        const progressUpdateIndex = buffer.indexOf('"progress_update": true');
        if (progressUpdateIndex > 0) {
            try {
                // Find JSON object boundaries by counting braces
                let openBraces = 0;
                let startPos = 0;
                let endPos = 0;
                
                // Find the opening brace for this object
                for (let i = progressUpdateIndex; i >= 0; i--) {
                    if (buffer[i] === '{') {
                        startPos = i;
                        break;
                    }
                }
                
                // Count braces to find the corresponding closing brace
                for (let i = startPos; i < buffer.length; i++) {
                    if (buffer[i] === '{') openBraces++;
                    if (buffer[i] === '}') {
                        openBraces--;
                        if (openBraces === 0) {
                            endPos = i + 1;
                            break;
                        }
                    }
                }
                
                // If we found a complete progress update object
                if (endPos > startPos) {
                    const progressData = JSON.parse(buffer.substring(startPos, endPos));
                    
                    // Process the progress update
                    processStreamingUpdate(progressData);
                    
                    // Remove the processed portion from buffer
                    buffer = buffer.substring(endPos);
                }
            } catch (e) {
                console.error("Error processing progress update:", e);
                // Continue processing - don't clear buffer here as it might contain partial data
            }
        }
        
        // Also try to parse the whole buffer as regular JSON when complete
        if (buffer.includes('"status": "completed"')) {
            try {
                // Try to parse the buffer as JSON
                const jsonData = JSON.parse(buffer);
                // If we get here, it's valid JSON
                processResults(jsonData);
                buffer = "";
            } catch (e) {
                // Not valid JSON yet, continue accumulating
                // Nothing to do, just continue
            }
        }
        
        // Continue reading
        return handleStreamingResponse(reader, decoder, buffer);
    });
}
        // Function to calculate estimated time remaining
        function calculateTimeRemaining(percentComplete) {
            const now = Date.now();
            
            // Add the current progress to our tracking arrays
            progressUpdateTimes.push(now);
            progressUpdateValues.push(percentComplete);
            
            // Keep only the last 10 updates for calculation
            if (progressUpdateTimes.length > 10) {
                progressUpdateTimes.shift();
                progressUpdateValues.shift();
            }
            
            // Need at least 2 points to estimate
            if (progressUpdateTimes.length < 2) {
                return "Calculating...";
            }
            
            // Calculate rate of progress
            const oldestTime = progressUpdateTimes[0];
            const oldestValue = progressUpdateValues[0];
            const timeElapsed = now - oldestTime; // ms
            const progressMade = percentComplete - oldestValue; // percentage points
            
            // Avoid division by zero
            if (progressMade <= 0) {
                return "Calculating...";
            }
            
            // Calculate rate: percentage points per ms
            const rate = progressMade / timeElapsed;
            
            // Calculate remaining time
            const remainingProgress = 100 - percentComplete;
            const estimatedTimeRemaining = remainingProgress / rate; // ms
            
            // Format nicely
            if (estimatedTimeRemaining < 60000) {
                // Less than a minute
                return `~${Math.round(estimatedTimeRemaining / 1000)}s remaining`;
            } else {
                // Minutes and seconds
                const minutes = Math.floor(estimatedTimeRemaining / 60000);
                const seconds = Math.round((estimatedTimeRemaining % 60000) / 1000);
                return `~${minutes}m ${seconds}s remaining`;
            }
        }

        // Function to update progress bar
        function updateProgress(percent, statusText, currentItem = null, finished = false) {
            if (progressContainer.style.display === 'none') {
                progressContainer.style.display = 'block';
            }
            
            // Update main progress bar
            progressBar.style.width = `${percent}%`;
            progressBar.setAttribute('aria-valuenow', percent);
            progressBar.textContent = `${Math.round(percent)}%`;
            progressStatusText.textContent = statusText;
            
            // Update time remaining if not finished
            if (!finished) {
                progressTimeRemaining.textContent = calculateTimeRemaining(percent);
            } else {
                progressTimeRemaining.textContent = "Complete!";
            }
            
            // Update current item if provided
            if (currentItem) {
                currentItemDetails.style.display = 'block';
                currentItemName.textContent = `Processing: ${currentItem.searchTerm || currentItem}`;
                
                // If this is a product with more details, show them
                if (currentItem.name) {
                    currentItemInfo.style.display = 'block';
                    currentItemInfo.textContent = currentItem.found ? 
                        `Found: ${currentItem.name} (${currentItem.available ? 'Available' : 'Unavailable'})` : 
                        `Not found: ${currentItem.notFoundMessage || 'No details available'}`;
                }
                
                // If we have batch information, show batch progress
                if (currentItem.batchCurrent && currentItem.batchTotal) {
                    updateBatchProgress(currentItem.batchCurrent, currentItem.batchTotal);
                }
            }
        }
        
        // Function to update batch progress
        function updateBatchProgress(current, total) {
            batchProgressContainer.style.display = 'block';
            
            const percent = Math.min(100, Math.round((current / total) * 100));
            batchProgressBar.style.width = `${percent}%`;
            batchProgressBar.setAttribute('aria-valuenow', percent);
            
            batchProgressLabel.textContent = `Batch ${current} of ${total} (${percent}%)`;
        }

        // Function to process and display search results
        function processResults(data) {
            // If this is not a streaming response, hide loading spinner
            if (!isProcessingLargeRequest) {
                loadingSpinner.style.display = 'none';
            }
            
            // If there's an error, show it and stop
            if (data.error) {
                searchInfo.style.display = 'block';
                searchResultsTitle.textContent = `Error`;
                resultStats.innerHTML = `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>Error: ${data.error}</div>`;
                return;
            }

            // Store region info if available
            if (data.region_info) {
                currentRegionInfo = data.region_info;

                // Update region banner
                regionInfoBanner.style.display = 'flex';
                const regionName = data.region_info.nickname || 'Unknown Region';
                const address = data.region_info.displayAddress || '';
                const postalCode = data.region_info.postalCode || '';

                regionText.innerHTML = `
                    <div>
                        <strong>${regionName}</strong><br>
                        ${address}<br>
                        <span class="badge bg-light text-dark">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            ${postalCode}
                        </span>
                    </div>
                `;
            }

            // Display duplicate message if there are duplicates in article search mode
            if (data.duplicate_count > 0 && data.search_type === 'article') {
                duplicatesFound = data.duplicates || [];
                
                duplicateMessage.style.display = 'block';
                duplicateText.textContent = `Found and removed ${data.duplicate_count} duplicate article code${data.duplicate_count > 1 ? 's' : ''}.`;
                
                // Show the toggle button if we have duplicates
                if (duplicatesFound.length > 0) {
                    toggleDuplicateList.style.display = 'inline-block';
                    
                    // Populate the duplicate list
                    duplicateList.innerHTML = '';
                    const dupList = document.createElement('ul');
                    duplicatesFound.forEach(dup => {
                        const item = document.createElement('li');
                        item.textContent = dup;
                        dupList.appendChild(item);
                    });
                    duplicateList.appendChild(dupList);
                } else {
                    toggleDuplicateList.style.display = 'none';
                }
            } else {
                duplicateMessage.style.display = 'none';
                toggleDuplicateList.style.display = 'none';
            }

            // Display parsed terms if available
            if (data.parsed_terms && data.parsed_terms.length > 0) {
                parsedTerms = data.parsed_terms;
                
                // Show the parsed terms section
                parsedTermsSection.style.display = 'block';
                parsedTermsList.innerHTML = '';
                
                // Create the list of parsed terms
                const termsList = document.createElement('ul');
                parsedTerms.forEach(term => {
                    const listItem = document.createElement('li');
                    listItem.textContent = term;
                    termsList.appendChild(listItem);
                });
                
                parsedTermsList.appendChild(termsList);
            }

            // For streaming responses, update progress if available
            if (data.status === 'processing' && data.total_terms && data.total_batches) {
                loadingMessage.textContent = `Processing ${data.total_terms} ${data.search_type === 'article' ? 'article codes' : 'search terms'} in ${data.total_batches} batches...`;
                progressTotal.textContent = data.total_terms;
            }

            // Count found and not found products
            if (data.products && data.products.length) {
                // Store all products for display and export
                allSearchResults = data.products;
                
                // Count normal and not found products
                const foundProducts = data.products.filter(p => p.found === true);
                const notFoundProds = data.products.filter(p => p.found === false);
                
                totalFoundProducts = data.total_found || foundProducts.length;
                notFoundProducts = notFoundProds.length;
                displayedProducts = data.products.length;
                
                // Show filter controls if we have products
                if (data.products.length > 0) {
                    filterControls.style.display = 'block';
                }
                
                // For streaming response, update progress based on processed products
                if (isProcessingLargeRequest && data.total_processed && data.total_terms) {
                    const percentComplete = (data.total_processed / data.total_terms) * 100;
                    const latestProduct = data.products.length > 0 ? data.products[data.products.length - 1] : null;
                    
                    // Update progress metrics
                    progressProcessed.textContent = data.total_processed;
                    progressFound.textContent = totalFoundProducts;
                    progressNotFound.textContent = notFoundProducts;
                    
                    updateProgress(
                        percentComplete,
                        `Processed ${data.total_processed} of ${data.total_terms} terms`,
                        latestProduct
                    );
                }
            }

            // Show results section
            showResultsSection();

            // Display products
            displayResults(allSearchResults, resultsContainer);
            
            // Apply default filter (show all)
            filterAll.checked = true;
            filterResults();
        }
        
        // Function to show results section
        function showResultsSection() {
            // Update results title
            const regionName = currentRegionInfo?.nickname || 'Unknown Region';
            searchResultsTitle.textContent = `Search Results for ${regionName}`;

            // Update stats
            resultStats.textContent = `Found ${totalFoundProducts} products, ${notFoundProducts} not found, showing ${displayedProducts} total`;

            // Show export button if we have results
            exportButton.style.display = allSearchResults.length > 0 ? 'block' : 'none';

            // Show results section
            searchInfo.style.display = 'block';
        }

        // Function to filter results based on radio buttons
        function filterResults() {
            let showCondition;
            
            if (filterAll.checked) {
                // Show all products
                showCondition = () => true;
            } else if (filterFound.checked) {
                // Show only found products
                showCondition = product => product.classList.contains('found-product');
            } else if (filterNotFound.checked) {
                // Show only not found products
                showCondition = product => product.classList.contains('not-found-card');
            } else if (filterAvailable.checked) {
                // Show only available products
                showCondition = product => product.classList.contains('found-product') && 
                                          product.querySelector('.badge-available');
            } else if (filterUnavailable.checked) {
                // Show only unavailable products
                showCondition = product => product.classList.contains('found-product') && 
                                          product.querySelector('.badge-unavailable');
            } else if (filterDiscounted.checked) {
                // Show only products with discounts
                showCondition = product => product.classList.contains('found-product') && 
                                          product.querySelector('.discount-badge');
            }
            
            // Apply filter to all product cards
            const allProductCards = document.querySelectorAll('.product-card');
            let visibleCount = 0;
            
            allProductCards.forEach(card => {
                const parentCol = card.closest('.col-md-4, .col-lg-3');
                if (parentCol) {
                    if (showCondition(card)) {
                        parentCol.style.display = 'block';
                        visibleCount++;
                    } else {
                        parentCol.style.display = 'none';
                    }
                }
            });
            
            // Show "no results" message if no products are visible
            if (visibleCount === 0 && allProductCards.length > 0) {
                noResultsMessage.style.display = 'block';
            } else {
                noResultsMessage.style.display = 'none';
            }
            
            // Update results stats
            resultStats.textContent = `Found ${totalFoundProducts} products, ${notFoundProducts} not found, showing ${visibleCount} of ${displayedProducts} total`;
        }
        
        // Function to sort results
        function sortResults(sortOption) {
            if (!allSearchResults || allSearchResults.length === 0) return;
            
            // Clear current results
            resultsContainer.innerHTML = '';
            
            // Clone array to avoid modifying the original
            let sortedResults = [...allSearchResults];
            
            // Sort based on option
            switch(sortOption) {
                case 'priceAsc':
                    sortedResults.sort((a, b) => {
                        if (!a.currentPrice) return 1;
                        if (!b.currentPrice) return -1;
                        return parseFloat(a.currentPrice) - parseFloat(b.currentPrice);
                    });
                    break;
                    
                case 'priceDesc':
                    sortedResults.sort((a, b) => {
                        if (!a.currentPrice) return 1;
                        if (!b.currentPrice) return -1;
                        return parseFloat(b.currentPrice) - parseFloat(a.currentPrice);
                    });
                    break;
                    
                case 'discountDesc':
                    sortedResults.sort((a, b) => {
                        const aDiscount = a.discountPercentage || 0;
                        const bDiscount = b.discountPercentage || 0;
                        return bDiscount - aDiscount;
                    });
                    break;
                    
                case 'nameAsc':
                    sortedResults.sort((a, b) => {
                        if (!a.name) return 1;
                        if (!b.name) return -1;
                        return a.name.localeCompare(b.name);
                    });
                    break;
                    
                case 'nameDesc':
                    sortedResults.sort((a, b) => {
                        if (!a.name) return 1;
                        if (!b.name) return -1;
                        return b.name.localeCompare(a.name);
                    });
                    break;
                    
                case 'default':
                default:
                    // For default, keep original order which preserves search order
                    break;
            }
            
            // Re-render results
            displayResults(sortedResults, resultsContainer);
            
            // Re-apply filters
            filterResults();
        }

        // Function to check region info when session ID is entered
        function checkRegionInfo() {
            const sessionId = document.getElementById('sessionId').value.trim();

            if (!sessionId) {
                regionInfoBanner.style.display = 'none';
                return;
            }

            // Show loading message
            regionInfoBanner.style.display = 'flex';
            regionText.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> Checking region information...';

            // Make API request to get region info
            fetch('/api/fetch-product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sessionId: sessionId,
                    searchTerm: 'milk',  // Use a common term just to get region info
                    limit: 1,  // Only need one result
                    searchType: 'article' // Use article search type
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                // Check if there's content
                if (response.headers.get('content-length') === '0') {
                    throw new Error('Server returned an empty response');
                }
                
                // Parse as JSON with error handling
                return response.text().then(text => {
                    if (!text || text.trim() === '') {
                        throw new Error('Empty response from server');
                    }
                    
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON parse error:', e);
                        console.error('Raw response:', text);
                        throw new Error(`Invalid JSON response: ${e.message}`);
                    }
                });
            })
            .then(data => {
                if (data.error) {
                    regionInfoBanner.style.display = 'none';
                    alert(`Error: ${data.error}`);
                    return;
                }

                // Extract region info
                if (data.region_info) {
                    currentRegionInfo = data.region_info;

                    // Update region banner
                    regionInfoBanner.style.display = 'flex';
                    const regionName = data.region_info.nickname || 'Unknown Region';
                    const address = data.region_info.displayAddress || '';
                    const postalCode = data.region_info.postalCode || '';

                    regionText.innerHTML = `
                        <div>
                            <strong>${regionName}</strong><br>
                            ${address}<br>
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                ${postalCode}
                            </span>
                        </div>
                    `;
                } else {
                    regionInfoBanner.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error fetching region info:', error);
                regionInfoBanner.style.display = 'flex';
                regionText.innerHTML = `
                    <div class="text-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Error connecting to Voila</strong><br>
                        Please check your session ID or try again later.
                    </div>
                `;
            });
        }

        // Abort any in-progress request
        function abortCurrentRequest() {
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
            
            if (streamingResponse) {
                try {
                    // Try to cancel the reader if it exists
                    if (streamingResponse.reader && streamingResponse.reader.cancel) {
                        streamingResponse.reader.cancel();
                    }
                } catch (e) {
                    console.error("Error cancelling stream:", e);
                }
                streamingResponse = null;
            }
            
            isProcessingLargeRequest = false;
        }

        // Main search function
        function searchProducts() {
            // Reset any previous search
            abortCurrentRequest();
            
            const sessionId = document.getElementById('sessionId').value.trim();
            const searchTermsInput = document.getElementById('searchTerms').value.trim();
            const resultLimit = document.getElementById('resultLimit').value;
            const searchType = articleSearch.checked ? 'article' : 'generic';

            // Validate inputs
            if (!sessionId) {
                alert('Please enter your Voila session ID');
                return;
            }

            if (!searchTermsInput) {
                alert('Please enter at least one search term');
                return;
            }
            
            // Create abort controller for request cancellation
            abortController = new AbortController();

            // Show loading spinner
            loadingSpinner.style.display = 'block';
            progressContainer.style.display = 'none';
            batchProgressContainer.style.display = 'none';
            currentItemDetails.style.display = 'none';
            loadingMessage.textContent = searchType === 'article' ? 'Searching for articles...' : 'Performing generic search...';
            resultsContainer.innerHTML = '';
            searchInfo.style.display = 'none';
            exportButton.style.display = 'none';
            parsedTermsSection.style.display = 'none';
            filterControls.style.display = 'none';
            duplicateMessage.style.display = 'none';
            duplicateList.style.display = 'none';
            toggleDuplicateList.style.display = 'none';
            noResultsMessage.style.display = 'none';

            // Reset progress tracking
            searchStartTime = Date.now();
            progressUpdateTimes = [];
            progressUpdateValues = [];
            progressProcessed.textContent = '0';
            progressTotal.textContent = '0';
            progressFound.textContent = '0';
            progressNotFound.textContent = '0';

            // Reset results
            allSearchResults = [];
            totalFoundProducts = 0;
            displayedProducts = 0;
            notFoundProducts = 0;
            parsedTerms = [];
            duplicatesFound = [];

            // Prepare request payload
            const payload = {
                sessionId: sessionId,
                searchTerm: searchTermsInput,
                limit: resultLimit,
                searchType: searchType
            };
            
            // Check if this might be a large request based on search type and input size
            let isLargeRequest = false;
            
            if (searchType === 'article') {
                // For article search, check commas, lines, EA codes
                const commaCount = (searchTermsInput.match(/,/g) || []).length;
                const lineCount = (searchTermsInput.match(/\n/g) || []).length;
                const eaCodeCount = (searchTermsInput.match(/\d+EA/gi) || []).length;
                
                isLargeRequest = (commaCount + lineCount > 30) || (eaCodeCount > 30) || searchTermsInput.length > 1000;
            } else {
                // For generic search, not likely to be a large batch request
                isLargeRequest = false;
            }
            
            isProcessingLargeRequest = isLargeRequest;
            
            if (isProcessingLargeRequest) {
                // For large requests, use streaming response
                loadingMessage.textContent = 'Processing large request, please wait...';
                updateProgress(0, 'Preparing to process large batch of product codes...');
                
                fetch('/api/fetch-product', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    signal: abortController.signal
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    
                    // Initialize stream processing
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    // Store stream info for potential cancellation
                    streamingResponse = { reader, decoder };
                    
                    // Begin processing the stream
                    return handleStreamingResponse(reader, decoder);
                })
                .catch(error => {
                    loadingSpinner.style.display = 'none';
                    searchInfo.style.display = 'block';
                    searchResultsTitle.textContent = `Error`;
                    
                    let errorMessage;
                    if (error.name === 'AbortError') {
                        errorMessage = '<div class="alert alert-warning">' +
                            '<i class="fas fa-exclamation-triangle me-2"></i>Search was cancelled by user.</div>';
                    } else {
                        console.error('Request error:', error);
                        errorMessage = `<div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Error:</strong> ${error.message}
                            <hr>
                            <p>Troubleshooting tips:</p>
                            <ul>
                                <li>Check your internet connection</li>
                                <li>Verify your session ID is still valid</li>
                                <li>Your search might be too large - try reducing the number of terms</li>
                                <li>Try refreshing the page and searching again</li>
                            </ul>
                        </div>`;
                    }
                    
                    resultStats.innerHTML = errorMessage;
                    
                    isProcessingLargeRequest = false;
                    streamingResponse = null;
                });
                
            } else {
                // For regular requests, use normal fetch
                fetch('/api/fetch-product', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    signal: abortController.signal
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    
                    // Check if there's content
                    if (response.headers.get('content-length') === '0') {
                        throw new Error('Server returned an empty response');
                    }
                    
                    // Parse as JSON with error handling
                    return response.text().then(text => {
                        if (!text || text.trim() === '') {
                            throw new Error('Empty response from server');
                        }
                        
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            console.error('JSON parse error:', e);
                            console.error('Raw response:', text);
                            throw new Error(`Invalid JSON response: ${e.message}`);
                        }
                    });
                })
                .then(data => {
                    processResults(data);
                })
                .catch(error => {
                    loadingSpinner.style.display = 'none';
                    searchInfo.style.display = 'block';
                    searchResultsTitle.textContent = `Error`;
                    
                    let errorMessage;
                    if (error.name === 'AbortError') {
                        errorMessage = '<div class="alert alert-warning">' +
                            '<i class="fas fa-exclamation-triangle me-2"></i>Search was cancelled by user.</div>';
                    } else {
                        console.error('Request error:', error);
                        errorMessage = `<div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Error:</strong> ${error.message}
                            <hr>
                            <p>Troubleshooting tips:</p>
                            <ul>
                                <li>Check your internet connection</li>
                                <li>Verify your session ID is still valid</li>
                                <li>Your search might be too large - try reducing the number of terms</li>
                                <li>Try refreshing the page and searching again</li>
                            </ul>
                        </div>`;
                    }
                    
                    resultStats.innerHTML = errorMessage;
                });
            }
        }

        function displayResults(products, containerElement) {
            if (!products || products.length === 0) {
                containerElement.innerHTML = '<div class="col-12 text-center mt-4"><div class="alert alert-info">' +
                    '<i class="fas fa-info-circle me-2"></i>No products found. Try different search terms.</div></div>';
                return;
            }

            // Only clear previous results if not streaming
            if (!isProcessingLargeRequest) {
                containerElement.innerHTML = '';
            }

            // Separate found and not found products
            const foundProducts = products.filter(product => product.found === true);
            const notFoundProducts = products.filter(product => product.found === false);

            // Display found products first
            foundProducts.forEach(product => {
                // Only add if this product isn't already displayed
                if (!document.getElementById(`product-${product.retailerProductId || product.productId || product.searchTerm}`)) {
                    const productCard = createProductCard(product);
                    containerElement.appendChild(productCard);
                }
            });

            // Then display not found products
            notFoundProducts.forEach(product => {
                // Only add if this product isn't already displayed
                if (!document.getElementById(`not-found-${product.searchTerm}`)) {
                    const notFoundCard = createNotFoundCard(product);
                    containerElement.appendChild(notFoundCard);
                }
            });
        }

        function createProductCard(product) {
            const productCard = document.createElement('div');
            productCard.className = 'col-md-4 col-lg-3 mb-4';
            productCard.id = `product-${product.retailerProductId || product.productId || product.searchTerm}`;

            // Format price display - Handle non-number values
            let priceDisplay = '';
            let discountBadge = '';

            if (product.currentPrice !== null && product.currentPrice !== undefined) {
                // Safely format the current price
                const formattedPrice = typeof product.currentPrice === 'number' 
                    ? product.currentPrice.toFixed(2) 
                    : product.currentPrice;

                priceDisplay = `<div class="price-tag">$${formattedPrice}`;

                // Handle discount percentage if available
                if (product.discountPercentage) {
                    discountBadge = `<span class="discount-badge">-${product.discountPercentage}%</span>`;
                    priceDisplay += discountBadge;
                }

                priceDisplay += `</div>`;

                // Handle original price if it exists
                if (product.originalPrice && product.originalPrice > product.currentPrice) {
                    // Safely format the original price
                    const formattedOriginal = typeof product.originalPrice === 'number'
                        ? product.originalPrice.toFixed(2)
                        : product.originalPrice;

                    priceDisplay += `<div class="original-price">$${formattedOriginal}</div>`;
                }
            } else {
                priceDisplay = '<div class="price-tag">Price unavailable</div>';
            }

            // Format unit price if available
            let unitPriceDisplay = '';
            if (product.unitPrice && product.unitLabel) {
                // Safely format the unit price
                const formattedUnitPrice = typeof product.unitPrice === 'number'
                    ? product.unitPrice.toFixed(2)
                    : product.unitPrice;

                unitPriceDisplay = `<div class="small text-muted">$${formattedUnitPrice} / ${product.unitLabel}</div>`;
            }

            // Format availability badge with classes for filtering
            const availabilityClass = product.available ? 'badge-available' : 'badge-unavailable';
            const availabilityBadge = product.available
                ? `<span class="badge bg-success ${availabilityClass}">
                      <i class="fas fa-check-circle me-1"></i>Available
                   </span>`
                : `<span class="badge bg-danger ${availabilityClass}">
                      <i class="fas fa-times-circle me-1"></i>Unavailable
                   </span>`;

            // Format offers and Scene+ offers
            let offersDisplay = '';
            if (product.offers && product.offers.length > 0) {
                offersDisplay = '<div class="mt-2 mb-2">';

                product.offers.forEach(offer => {
                    if (offer.description && offer.description.includes('SCENE+')) {
                        offersDisplay += `<span class="scene-badge">
                            <i class="fas fa-ticket-alt me-1"></i>${offer.description}</span>`;
                    } else if (offer.description) {
                        offersDisplay += `<span class="offer-badge">
                            <i class="fas fa-tag me-1"></i>${offer.description}</span>`;
                    }
                });

                offersDisplay += '</div>';
            }

            // Add search term badge if available
            const searchTermBadge = product.searchTerm 
                ? `<div class="mb-2"><span class="badge bg-info">
                      <i class="fas fa-search me-1"></i>${product.searchTerm}
                   </span></div>` 
                : '';

            productCard.innerHTML = `
                <div class="card product-card found-product">
                    <img src="${product.imageUrl || 'https://via.placeholder.com/200x200?text=No+Image'}" 
                         class="card-img-top product-img" alt="${product.name || 'Product Image'}"
                         onerror="this.src='https://via.placeholder.com/200x200?text=No+Image'">
                    <div class="card-body">
                        <h5 class="card-title">${product.name || 'Unknown Product'}</h5>
                        <p class="card-text small text-muted">${product.brand || 'Unknown brand'}</p>
                        ${searchTermBadge}
                        ${offersDisplay}
                        <div class="mb-2">
                            ${priceDisplay}
                            ${unitPriceDisplay}
                        </div>
                        <div>
                            ${availabilityBadge}
                        </div>
                    </div>
                    <div class="card-footer bg-white">
                        <small class="text-muted">ID: ${product.retailerProductId || product.productId || 'N/A'}</small>
                    </div>
                </div>
            `;

            return productCard;
        }

        function createNotFoundCard(product) {
            const notFoundCard = document.createElement('div');
            notFoundCard.className = 'col-md-4 col-lg-3 mb-4';
            notFoundCard.id = `not-found-${product.searchTerm}`;

            // Add search term badge if available
            const searchTermBadge = product.searchTerm 
                ? `<div class="mb-2"><span class="badge bg-info">
                      <i class="fas fa-search me-1"></i>${product.searchTerm}
                   </span></div>` 
                : '';

            notFoundCard.innerHTML = `
                <div class="card product-card not-found-card">
                    <div class="card-body text-center">
                        <div class="py-4">
                            <i class="fas fa-exclamation-triangle not-found-icon mb-3"></i>
                            <h5 class="card-title not-found-title">Article Not Found</h5>
                            ${searchTermBadge}
                            <p class="card-text not-found-message">
                                ${product.notFoundMessage || 'This article was not found. It may not be published yet or could be a typo.'}
                            </p>
                        </div>
                    </div>
                    <div class="card-footer bg-white">
                        <small class="text-muted">Search term: ${product.searchTerm || 'N/A'}</small>
                    </div>
                </div>
            `;

            return notFoundCard;
        }

        function exportToExcel(option = 'all') {
            if (!allSearchResults || allSearchResults.length === 0) {
                alert('No results to export');
                return;
            }

            // Filter products based on the selected option
            let productsToExport;
            
            switch (option) {
                case 'found':
                    productsToExport = allSearchResults.filter(p => p.found === true);
                    break;
                case 'notFound':
                    productsToExport = allSearchResults.filter(p => p.found === false);
                    break;
                case 'available':
                    productsToExport = allSearchResults.filter(p => p.found === true && p.available === true);
                    break;
                case 'unavailable':
                    productsToExport = allSearchResults.filter(p => p.found === true && p.available === false);
                    break;
                case 'currentView':
                    // Get currently visible products based on the applied filter
                    const visibleIds = Array.from(document.querySelectorAll('.col-md-4[style="display: block;"], .col-lg-3[style="display: block;"]'))
                        .map(col => {
                            const productCard = col.querySelector('.product-card');
                            if (productCard.classList.contains('not-found-card')) {
                                // Not found products - get searchTerm
                                const searchTerm = col.id.replace('not-found-', '');
                                return { type: 'notFound', term: searchTerm };
                            } else {
                                // Found products - get ID
                                const id = col.id.replace('product-', '');
                                return { type: 'found', id: id };
                            }
                        });
                        
                    productsToExport = allSearchResults.filter(product => {
                        if (product.found === false) {
                            return visibleIds.some(item => 
                                item.type === 'notFound' && item.term === product.searchTerm);
                        } else {
                            const productId = product.retailerProductId || product.productId || product.searchTerm;
                            return visibleIds.some(item => 
                                item.type === 'found' && item.id === productId);
                        }
                    });
                    break;
                default:
                    // 'all' - export everything
                    productsToExport = allSearchResults;
            }

            // Create a new workbook
            const wb = XLSX.utils.book_new();

            // Prepare data for export - create a flat array of data
            const exportData = productsToExport.map(product => {
                // Format offers for Excel
                let sceneOffers = '';
                let otherOffers = '';

                if (product.offers && product.offers.length > 0) {
                    product.offers.forEach(offer => {
                        const offerText = offer.description || offer.promotionText || '';
                        if (offerText && offerText.includes('SCENE+')) {
                            sceneOffers += (sceneOffers ? ', ' : '') + offerText;
                        } else if (offerText) {
                            otherOffers += (otherOffers ? ', ' : '') + offerText;
                        }
                    });
                }

                // Calculate discount percentage if not already done
                let discountPercentage = product.discountPercentage;
                if (!discountPercentage && product.originalPrice && product.currentPrice) {
                    try {
                        const current = parseFloat(product.currentPrice);
                        const original = parseFloat(product.originalPrice);
                        if (original > current) {
                            discountPercentage = Math.round(
                                ((original - current) / original) * 100
                            );
                        }
                    } catch (e) {
                        // Ignore calculation errors
                    }
                }

                // Check if this is a not found product
                if (product.found === false) {
                    return {
                        "Search Term": product.searchTerm || 'N/A',
                        "Product ID": 'NOT_FOUND',
                        "Name": `Article Not Found: ${product.searchTerm || ''}`,
                        "Brand": 'N/A',
                        "Category": 'N/A',
                        "Current Price": 'N/A',
                        "Original Price": 'N/A',
                        "Discount %": 'N/A',
                        "Unit Price": 'N/A',
                        "Unit": 'N/A',
                        "Available": 'No',
                        "Scene+ Offers": 'N/A',
                        "Other Offers": 'N/A',
                        "Image URL": 'N/A',
                        "Not Found Reason": product.notFoundMessage || 'Article not published or typo'
                    };
                }

                // Return formatted row for normal product
                return {
                    "Search Term": product.searchTerm || 'N/A',
                    "Product ID": product.retailerProductId || product.productId || 'N/A',
                    "Name": product.name || 'N/A',
                    "Brand": product.brand || 'N/A',
                    "Category": product.category || 'N/A',
                    "Current Price": product.currentPrice ? `$${product.currentPrice}` : 'N/A',
                    "Original Price": product.originalPrice ? `$${product.originalPrice}` : 'N/A',
                    "Discount %": discountPercentage ? `${discountPercentage}%` : 'N/A',
                    "Unit Price": product.unitPrice ? `$${product.unitPrice}` : 'N/A',
                    "Unit": product.unitLabel || 'N/A',
                    "Available": product.available ? 'Yes' : 'No',
                    "Scene+ Offers": sceneOffers || 'None',
                    "Other Offers": otherOffers || 'None',
                    "Image URL": product.imageUrl || 'N/A',
                    "Not Found Reason": ''
                };
            });

            // Convert to worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Create column widths
            const wscols = [
                {wch: 20}, // Search Term
                {wch: 15}, // Product ID
                {wch: 40}, // Name
                {wch: 15}, // Brand
                {wch: 25}, // Category
                {wch: 15}, // Current Price
                {wch: 15}, // Original Price
                {wch: 12}, // Discount %
                {wch: 15}, // Unit Price
                {wch: 10}, // Unit
                {wch: 10}, // Available
                {wch: 30}, // Scene+ Offers
                {wch: 30}, // Other Offers
                {wch: 50}, // Image URL
                {wch: 40}  // Not Found Reason
            ];

            ws['!cols'] = wscols;

            // Add the worksheet to the workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Products');

            // Get timestamp for filename
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

            // Get region info for filename
            const regionName = currentRegionInfo?.nickname || 'Unknown';
            const postalCode = currentRegionInfo?.postalCode || '';
            
            // Add export type to filename
            let exportTypeLabel = '';
            switch (option) {
                case 'found': exportTypeLabel = '-Found'; break;
                case 'notFound': exportTypeLabel = '-NotFound'; break;
                case 'available': exportTypeLabel = '-Available'; break;
                case 'unavailable': exportTypeLabel = '-Unavailable'; break;
                case 'currentView': exportTypeLabel = '-Filtered'; break;
            }

            // Create a descriptive filename with region details
            const filename = `Voila-${regionName}-${postalCode}${exportTypeLabel}-Products-${timestamp}.xlsx`;

            // Generate Excel file
            XLSX.writeFile(wb, filename);
        }

        // Helper function to format elapsed time
        function formatElapsedTime(seconds) {
            if (seconds < 60) {
                return `${Math.round(seconds)} sec`;
            } else {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.round(seconds % 60);
                return `${minutes}m ${remainingSeconds}s`;
            }
        }
    });
</script>
</body>
</html>
